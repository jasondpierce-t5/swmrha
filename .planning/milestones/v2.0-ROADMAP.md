# Milestone v2.0: Member Portal & Payments

**Status:** ✅ SHIPPED 2026-02-18
**Phases:** 14-21
**Total Plans:** 23

## Overview

Full member portal with Stripe-powered payments for membership dues, show entries, and additional fees — with both member accounts and guest checkout. Built complete payment infrastructure from scratch including webhook fulfillment, idempotent processing, and admin refund capabilities.

## Phases

### Phase 14: Stripe Foundation & Member Auth

**Goal**: Set up Stripe SDK, create member registration/login separate from admin, email verification
**Depends on**: v1.1 complete
**Plans**: 3 plans

Plans:
- [x] 14-01: Stripe SDK Foundation (server/client singletons, webhook handler with signature verification)
- [x] 14-02: Members Database & Auth Infrastructure (members table, RLS, split triggers, middleware, email confirmation)
- [x] 14-03: Member Registration & Login Pages (registration, login, LayoutWrapper update)

**Details:**
- Stripe server SDK singleton and browser-side Stripe.js loader singleton
- Webhook POST handler with signature verification and event routing (always returns 200 to prevent retry storms)
- Members table with full profile fields, membership tracking, Stripe customer ID
- Split BEFORE/AFTER INSERT triggers to avoid FK violation on signup
- Middleware protects `/member/*` routes, role-aware auth callback
- Email confirmation route (`/auth/confirm`) separate from PKCE callback

### Phase 15: Member Portal & Profiles

**Goal**: Build member dashboard shell, profile management, payment history UI
**Depends on**: Phase 14
**Plans**: 2 plans

Plans:
- [x] 15-01: Member Portal Shell & Dashboard (layout, sidebar, header, dashboard, member actions)
- [x] 15-02: Profile Management & Payment History (profile view/edit, payment history placeholder)

**Details:**
- MemberLayoutShell, MemberSidebar, MemberHeader with dark western theme and responsive sidebar
- `(portal)` route group prevents auth-checking layout from wrapping login/register pages
- Dashboard with welcome banner, membership status card, profile summary, quick links grid
- Profile view (read-only sections) and edit page with field restrictions (system fields are admin-managed)
- Payment history placeholder ready for Phase 17 integration

### Phase 16: Membership Management

**Goal**: Membership types/tiers in Supabase, admin CRUD for membership configuration, pricing
**Depends on**: Phase 15
**Plans**: 3 plans

Plans:
- [x] 16-01: Database & Server Actions (membership_types table, types, CRUD actions, admin nav)
- [x] 16-02: Admin Membership Types UI & Public Page (admin CRUD pages, dynamic public tiers)
- [x] 16-03: Admin Members UI (member list, edit form, delete, status badges)

**Details:**
- `membership_types` table with seed data (Individual $50, Family $75, Youth $25, Lifetime $500)
- Loosely coupled via slug (no FK from members to membership_types) for flexibility
- Public read access for active types (needed for public pricing page)
- Admin CRUD with price dollars-to-cents conversion and dynamic benefits array
- Admin members list with color-coded status badges (green=active, yellow=pending, red=expired)
- Public membership page replaced with dynamic tier cards from database

### Phase 17: Membership Payments

**Goal**: Stripe checkout for dues, renewal tracking, receipts, membership status updates
**Depends on**: Phase 16
**Plans**: 3 plans

Plans:
- [x] 17-01: Payments Data Layer & Checkout Session (migration, types, admin client, checkout action)
- [x] 17-02: Webhook Fulfillment & Checkout Pages (fulfillment handler, success/cancel pages)
- [x] 17-03: Checkout UI & Payment History (pay-dues page, payment history, dashboard CTAs)

**Details:**
- `payments` table with SELECT-only RLS; all writes via service role admin client
- Supabase admin client (`createAdminClient()`) for secure server-side writes
- Dynamic payment type resolution from member status (pending→dues, active/expired→renewal)
- Idempotent webhook fulfillment with fallback payment creation for duplicate webhooks
- Calendar-aware month calculation for membership expiry
- Checkout success page with three states (succeeded, pending, generic)
- Dashboard CTAs with contextual messaging (expired, pending, expiring-soon, active)

### Phase 18: Show Entry System

**Goal**: Show class/event management, entry selection UI, pricing configuration
**Depends on**: Phase 17
**Plans**: 4 plans

Plans:
- [x] 18-01: Show Classes Database & Server Actions (migration, types, CRUD actions)
- [x] 18-02: Admin Show Class Management UI (list, create, edit, delete pages)
- [x] 18-03: Show Entries Database & Server Actions (entries + junction tables, types, entry actions)
- [x] 18-04: Member Show Entry UI & Dashboard Integration (multi-step form, entries list, navigation)

**Details:**
- `show_classes` table with UNIQUE constraint on (show_id, name) and seed data (9 classes per show)
- `show_entries` and `show_entry_classes` junction table with fee snapshot pattern
- Junction table `fee_cents` snapshots class fee at entry time (protects against later price changes)
- Multi-step entry registration: select show → add horse/rider entries with class checkboxes → review summary
- Entries saved as draft; payment integration deferred to Phase 19
- Admin show class CRUD with fee dollar-to-cents conversion

### Phase 19: Show Entry Payments

**Goal**: Stripe checkout for show entries, confirmation flow, entry tracking in member portal
**Depends on**: Phase 18
**Plans**: 2 plans

Plans:
- [x] 19-01: Entry Checkout Session & Webhook Fulfillment (server actions, multi-line-item checkout, payment dispatch)
- [x] 19-02: Entry Payment UI & Checkout Flow (PayEntryButton, Save & Pay, context-aware success/cancel)

**Details:**
- One Stripe line item per entry (horse/rider combo with class descriptions) for clear receipt itemization
- Payment type dispatch in `fulfillCheckoutSession` (entry_fees vs membership routing)
- Individual entry confirmation (partial failures don't block remaining entries)
- PayEntryButton supports both draft and pending_payment entries (allows retry on abandoned checkout)
- "Save & Pay Now" dual-button flow chains entry creation into checkout

### Phase 20: Guest Checkout & Additional Fees

**Goal**: Guest checkout flow for non-members, stall fees, banquet tickets, other event charges
**Depends on**: Phase 19
**Plans**: 4 plans

Plans:
- [x] 20-01: Additional Fees Data Layer (migration, types, CRUD + checkout + fulfillment actions)
- [x] 20-02: Admin Fee Items UI (list, create, edit, delete pages + navigation)
- [x] 20-03: Guest Purchase UI & Checkout Flow (public /purchase page, success/cancel pages)
- [x] 20-04: Member Fee Purchase & Integration (member portal purchase, checkout updates, navigation)

**Details:**
- `additional_fee_types` and `fee_purchases` tables; payments table altered for guest support
- Nullable `member_id` on payments with `guest_email`/`guest_name` for guest checkout
- Dual-auth checkout in single action (attempts auth, branches on result)
- Public purchase page with category-grouped fee items and quantity selectors
- Member purchase page with same checkout action (detects auth automatically)
- Fee categories: stall, banquet, vendor, other

### Phase 21: Payment Admin & Polish

**Goal**: Admin payment dashboard, refund processing, reports, UAT across all payment flows
**Depends on**: Phase 20
**Plans**: 2 plans

Plans:
- [x] 21-01: Admin Payment Data Layer & Payments List (server actions, list page, navigation, dashboard)
- [x] 21-02: Payment Detail & Refund Processing (detail page, Stripe refund, UAT checkpoint)

**Details:**
- Admin payments list with 4-card summary stats (total revenue, total payments, by-type, by-status)
- Batch member lookup (single IN query) to avoid N+1
- Payment type badges color-coded (gold=membership, blue=entry fees, purple=additional fees)
- Payment detail page with related items display (entries, fee purchases, membership info)
- `processRefund` server action: validates, calls Stripe refunds API, updates status, cascades to related records
- Full refund only (no partial); refund does NOT auto-change membership status

---

## Milestone Summary

**Key Decisions:**
- Split signup trigger into BEFORE/AFTER INSERT (FK constraint requires auth.users row first)
- `(portal)` route group for authenticated member routes (prevents redirect loops)
- Loosely coupled membership_types via slug (no FK to members)
- price_cents integer storage with dollar display conversion (standard Stripe pattern)
- Payments SELECT-only RLS; all writes via service role admin client
- Dynamic payment type resolution from member status
- Idempotent webhook fulfillment with fallback payment creation
- Fee snapshot pattern in show_entry_classes junction table
- One Stripe line item per entry for clear receipt itemization
- Nullable member_id on payments for guest checkout
- Dual-auth checkout (single action handles both member and guest)
- processRefund does NOT auto-change membership status (admin manages separately)
- Full Stripe refund only (no partial refund support)

**Issues Resolved:**
- FK violation on member signup (split BEFORE/AFTER INSERT triggers)
- Auth redirect loops (portal route group solution)
- PaymentRow type compilation error after adding nullable fields (added null defaults)
- Admin client eager creation blocking checkout (deferred to point of use)
- OneDrive EPERM on .next cache directory (not a code issue)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- `next/image` still not used with Supabase Storage URLs (remotePatterns not configured)
- No partial refund support (full refund only)
- No password reset flow for members
- No email notifications for payment confirmations

---

_For current project status, see .planning/ROADMAP.md_
