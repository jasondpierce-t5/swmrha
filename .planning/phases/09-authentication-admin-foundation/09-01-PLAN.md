---
phase: 09-authentication-admin-foundation
plan: 01
type: execute
depends_on: []
files_modified: [package.json, .env.local.example, src/lib/supabase/client.ts, src/lib/supabase/server.ts, src/lib/supabase/middleware.ts, src/middleware.ts, src/app/auth/callback/route.ts]
---

<objective>
Set up Supabase Auth infrastructure with SSR-compatible client utilities, middleware-based route protection, and auth callback handling.

Purpose: Establish the auth foundation that all admin features depend on — Supabase chosen as long-term platform for future database, user accounts, and points tracking.
Output: Three Supabase client utilities (browser, server, middleware), route-protecting middleware, auth callback handler, and env template.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-authentication-admin-foundation/09-CONTEXT.md

# Key files from prior phases:
@src/app/layout.tsx
@src/lib/navigation.ts
@src/app/globals.css
@package.json

**Tech stack available:** Next.js 16.1.6, React 19, Tailwind CSS v4, TypeScript 5, @heroicons/react
**Established patterns:** App Router pages, src/ directory structure, Tailwind v4 CSS-based config
**Constraining decisions:**
- Phase 01-01: Next.js 16.1.6 with App Router
- Phase 01-02: Tailwind v4 with @theme inline CSS config
- Phase 08-01: /admin routes not in public nav (demo pages removed from nav)
- 09-CONTEXT: Supabase chosen as auth provider (long-term platform investment)
- 09-CONTEXT: Individual admin accounts per board member
- 09-CONTEXT: RBAC via app_metadata for admin role (simplest approach, secure — only service role can modify)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase packages and create client utilities</name>
  <files>package.json, .env.local.example, src/lib/supabase/client.ts, src/lib/supabase/server.ts, src/lib/supabase/middleware.ts</files>
  <action>
Install @supabase/supabase-js and @supabase/ssr packages (NOT the deprecated @supabase/auth-helpers-nextjs).

Create .env.local.example with required environment variables:
- NEXT_PUBLIC_SUPABASE_URL=your-supabase-project-url
- NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key

Create three Supabase client utilities in src/lib/supabase/:

1. client.ts — Browser client for Client Components:
   - Use createBrowserClient from @supabase/ssr
   - Reference NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY env vars
   - Export a createClient() function

2. server.ts — Server client for Server Components, Server Actions, Route Handlers:
   - Use createServerClient from @supabase/ssr
   - Use cookies() from next/headers (must await it in Next.js 16)
   - Implement getAll/setAll cookie handlers
   - The setAll try/catch is intentional — Server Components can't write cookies, middleware handles it
   - Export an async createClient() function

3. middleware.ts — Middleware client for session refresh and route protection:
   - Use createServerClient from @supabase/ssr
   - Accept NextRequest, return NextResponse
   - Implement cookie forwarding between request and response
   - Call supabase.auth.getUser() immediately after creating client (CRITICAL: no code between createServerClient and getUser — causes random logouts)
   - Export an async updateSession(request) function that returns supabaseResponse
  </action>
  <verify>npm ls @supabase/supabase-js @supabase/ssr shows both packages installed. TypeScript compilation of all three files passes (npx tsc --noEmit src/lib/supabase/*.ts or npm run build with no type errors).</verify>
  <done>Three Supabase client utilities exist with correct patterns, .env.local.example documents required vars, packages installed.</done>
</task>

<task type="auto">
  <name>Task 2: Create middleware and auth callback route</name>
  <files>src/middleware.ts, src/app/auth/callback/route.ts</files>
  <action>
Create src/middleware.ts (root level, Next.js convention):
- Import updateSession from @/lib/supabase/middleware
- Export async middleware function that calls updateSession(request)
- Add route protection logic inside updateSession: if request path starts with /admin and no user (or user.app_metadata.role !== 'admin'), redirect to /login
- Public routes (/login, /auth, all non-admin pages) should pass through without auth checks
- Export config.matcher that excludes static files, images, and favicon:
  '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'

Create src/app/auth/callback/route.ts:
- Handle GET request for Supabase auth redirects (magic links, OAuth, email confirmation)
- Extract 'code' from URL searchParams
- If code exists, create server Supabase client and call exchangeCodeForSession(code)
- Redirect to /admin on success, /login on failure
- Use NextResponse.redirect with request.nextUrl for proper URL construction

IMPORTANT: The middleware should ONLY protect /admin/* routes. All public pages must remain accessible without auth. Do not redirect public visitors to login.
  </action>
  <verify>npm run build succeeds with middleware in place. Verify middleware file is at src/middleware.ts (not nested). Check that the matcher pattern is correct.</verify>
  <done>Middleware protects /admin/* routes, passes through all public routes. Auth callback route handles code exchange. Build passes.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Set up Supabase project and configure environment</action>
  <instructions>
I've created the auth infrastructure code. Now you need to connect it to a real Supabase project:

1. **Create Supabase project** (if not already done):
   - Go to https://supabase.com/dashboard
   - Create a new project (or use existing)
   - Wait for project to initialize

2. **Get credentials:**
   - Go to Project Settings → API
   - Copy the **Project URL** and **anon/public key**

3. **Create .env.local:**
   - Copy .env.local.example to .env.local
   - Fill in NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY

4. **Create initial admin user:**
   - Go to Authentication → Users in Supabase Dashboard
   - Click "Add User" → create with email/password
   - After user is created, go to SQL Editor and run:
     ```sql
     UPDATE auth.users
     SET raw_app_meta_data = raw_app_meta_data || '{"role": "admin"}'
     WHERE email = 'your-admin-email@example.com';
     ```
   - This sets the admin role in app_metadata (users cannot modify this themselves)

5. **Verify:** Run `npm run dev` — the site should load normally on public pages.
  </instructions>
  <verification>npm run dev starts without Supabase errors. Public pages load normally. .env.local exists with valid credentials.</verification>
  <resume-signal>Type "done" when Supabase project is configured and .env.local has valid credentials</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] @supabase/supabase-js and @supabase/ssr in package.json dependencies
- [ ] Three client utilities in src/lib/supabase/ with correct patterns
- [ ] src/middleware.ts exists at project root with /admin protection
- [ ] src/app/auth/callback/route.ts handles code exchange
- [ ] .env.local.example documents required environment variables
- [ ] npm run build succeeds
- [ ] Public pages remain accessible without auth
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Supabase project connected with valid credentials
- Admin routes protected, public routes unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/09-authentication-admin-foundation/09-01-SUMMARY.md`
</output>
