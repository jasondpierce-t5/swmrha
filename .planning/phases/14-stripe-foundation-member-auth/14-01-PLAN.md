---
phase: 14-stripe-foundation-member-auth
plan: 01
type: execute
depends_on: []
files_modified: [package.json, src/lib/stripe/server.ts, src/lib/stripe/client.ts, src/app/api/webhooks/stripe/route.ts, .env.local.example]
---

<objective>
Set up Stripe SDK foundation with server client, browser loader, and webhook handler.

Purpose: Establish the Stripe infrastructure all payment features (membership dues, show entries, guest checkout) will build on in Phases 17-20.
Output: Stripe server/client utilities, webhook endpoint with signature verification, environment variable documentation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
@.env.local.example

**Tech stack available:** Next.js 16.1.6, @supabase/ssr, @supabase/supabase-js, Tailwind v4, TypeScript 5
**Established patterns:** Three-client pattern in src/lib/supabase/ (browser/server/middleware), server actions in src/lib/actions/
**Constraining decisions:**
- Phase 9: Supabase SSR auth with cookie-based sessions, middleware route protection
- Phase 9: Environment variables documented in .env.local.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe packages and create server/client utilities</name>
  <files>package.json, src/lib/stripe/server.ts, src/lib/stripe/client.ts</files>
  <action>
  Install three Stripe packages: `stripe` (server SDK), `@stripe/stripe-js` (browser loader), `@stripe/react-stripe-js` (React components for future payment forms).

  Create src/lib/stripe/server.ts — server-side Stripe singleton:
  - Import Stripe from 'stripe'
  - Export `const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, { typescript: true })`
  - Do NOT set apiVersion explicitly — use the SDK default pinned to the installed version
  - This file is server-only (no 'use client' directive)

  Create src/lib/stripe/client.ts — browser-side Stripe.js loader:
  - Import { loadStripe } from '@stripe/stripe-js'
  - Use singleton pattern: cache the promise in a module-level variable
  - Export `getStripe()` function that returns the cached `loadStripe(NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY)` promise
  - This ensures loadStripe is called only once per page load

  Mirror the existing src/lib/supabase/ directory structure (server.ts + client.ts pattern).
  </action>
  <verify>
  - `npm ls stripe @stripe/stripe-js @stripe/react-stripe-js` shows all three installed
  - `npx tsc --noEmit` passes (TypeScript compilation check)
  - Build succeeds: `npm run build`
  </verify>
  <done>Three Stripe packages installed, server client exports stripe instance, browser client exports getStripe() singleton</done>
</task>

<task type="auto">
  <name>Task 2: Create Stripe webhook handler and update env docs</name>
  <files>src/app/api/webhooks/stripe/route.ts, .env.local.example</files>
  <action>
  Create src/app/api/webhooks/stripe/route.ts — POST handler for Stripe webhook events:
  - Import { stripe } from '@/lib/stripe/server' and Stripe type from 'stripe'
  - Read STRIPE_WEBHOOK_SECRET from process.env
  - CRITICAL: Use `await request.text()` to get raw body — NOT `request.json()`. Signature verification requires the exact raw body string. Using JSON parse/stringify changes whitespace and breaks verification.
  - Get 'stripe-signature' header from request.headers
  - Call `stripe.webhooks.constructEvent(body, signature, webhookSecret)` in a try/catch
  - Return 400 if signature missing or verification fails
  - Handle event types in a switch statement with these initial cases:
    - 'checkout.session.completed': log session.id (placeholder for Phase 17+ fulfillment)
    - 'payment_intent.succeeded': log paymentIntent.id
    - 'payment_intent.payment_failed': log error
    - default: log unhandled event type
  - Return `NextResponse.json({ received: true })` with status 200 on success
  - Wrap event processing in try/catch — always return 200 to Stripe even if processing fails (log the error)

  Update .env.local.example to add Stripe environment variables:
  - STRIPE_SECRET_KEY=sk_test_your-stripe-secret-key
  - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_your-stripe-publishable-key
  - STRIPE_WEBHOOK_SECRET=whsec_your-stripe-webhook-secret
  - NEXT_PUBLIC_APP_URL=http://localhost:3000
  Keep existing Supabase variables in the file.
  </action>
  <verify>
  - `npm run build` succeeds (webhook route compiles)
  - Route file exists at correct path: `ls src/app/api/webhooks/stripe/route.ts`
  - .env.local.example contains all four Stripe variables
  </verify>
  <done>Webhook route handles POST with signature verification, returns 200 on valid events, 400 on invalid signature. .env.local.example documents all required Stripe env vars.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure Stripe API keys in .env.local</action>
  <instructions>
    I've installed Stripe packages and created the server client, browser loader, and webhook handler.

    Now you need to add your Stripe API keys:

    1. Go to https://dashboard.stripe.com/test/apikeys
    2. Copy your **Publishable key** (pk_test_...) and **Secret key** (sk_test_...)
    3. Add to your `.env.local` file:
       ```
       STRIPE_SECRET_KEY=sk_test_your-key-here
       NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_your-key-here
       NEXT_PUBLIC_APP_URL=http://localhost:3000
       ```

    4. For webhook testing (optional now, required in Phase 17):
       - Install Stripe CLI: https://docs.stripe.com/stripe-cli
       - Run: `stripe listen --forward-to localhost:3000/api/webhooks/stripe`
       - Copy the webhook signing secret (whsec_...) to `.env.local`:
         ```
         STRIPE_WEBHOOK_SECRET=whsec_your-secret-here
         ```
  </instructions>
  <verification>npm run build succeeds with Stripe env vars configured</verification>
  <resume-signal>Type "done" when Stripe keys are configured in .env.local</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] src/lib/stripe/server.ts exports stripe instance
- [ ] src/lib/stripe/client.ts exports getStripe() function
- [ ] src/app/api/webhooks/stripe/route.ts handles POST with signature verification
- [ ] .env.local.example documents all Stripe env vars
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Stripe server client and browser loader available for future phases
- Webhook handler ready to receive Stripe events
</success_criteria>

<output>
After completion, create `.planning/phases/14-stripe-foundation-member-auth/14-01-SUMMARY.md`
</output>
