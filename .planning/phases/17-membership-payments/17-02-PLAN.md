---
phase: 17-membership-payments
plan: 02
type: execute
depends_on: ["17-01"]
files_modified: [src/app/api/webhooks/stripe/route.ts, src/lib/actions/fulfillment.ts, src/app/member/(portal)/checkout/success/page.tsx, src/app/member/(portal)/checkout/cancel/page.tsx]
domain: null
---

<objective>
Implement Stripe webhook fulfillment for checkout.session.completed and create checkout success/cancel redirect pages.

Purpose: Complete the server-side payment flow — when Stripe confirms payment, update member status and payment records; provide member-facing confirmation/cancellation pages.
Output: Working webhook fulfillment handler, checkout success page showing payment confirmation, cancel page with retry link.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Prior plan in this phase:
@.planning/phases/17-membership-payments/17-01-SUMMARY.md

# Key source files:
@src/app/api/webhooks/stripe/route.ts
@src/lib/stripe/server.ts
@src/lib/supabase/admin.ts
@src/types/database.ts
@src/lib/actions/payments.ts

**Tech stack available:** stripe, @supabase/supabase-js (admin client)
**Established patterns:**
- Webhook always returns 200 to prevent Stripe retry storms
- Admin client bypasses RLS for system operations
- PaymentRow type for database records
- Checkout session metadata: { member_id, membership_type_slug, payment_type }

**Constraining decisions:**
- Phase 14: Webhook returns 200 even on processing errors, uses raw body text for signature verification
- Phase 16: price_cents integer storage, duration_months determines expiry calculation (null = lifetime/no expiry)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement checkout.session.completed webhook fulfillment</name>
  <files>src/lib/actions/fulfillment.ts, src/app/api/webhooks/stripe/route.ts</files>
  <action>
1. Create `src/lib/actions/fulfillment.ts` (NOT a server action — a plain module for webhook use):

   Export `fulfillCheckoutSession(session: Stripe.Checkout.Session)`:
   - Use admin client (from `@/lib/supabase/admin`) for all DB operations
   - **Idempotency check:** Query payments WHERE stripe_checkout_session_id = session.id AND status = 'succeeded'. If found, return early (already fulfilled).
   - **Update payment record:** Find payment by stripe_checkout_session_id = session.id, update:
     - `status: 'succeeded'`
     - `stripe_payment_intent_id: session.payment_intent` (cast to string if object)
   - **If no pending payment found:** This shouldn't happen (checkout action creates it), but log a warning and create a new payment record from session metadata as fallback. Extract member_id, membership_type_slug, payment_type from session.metadata.
   - **Update member membership fields:**
     - Query membership_types by slug from session.metadata.membership_type_slug to get duration_months
     - `membership_type: session.metadata.membership_type_slug`
     - `membership_status: 'active'`
     - `membership_start: new Date().toISOString()`
     - `membership_expiry`: if duration_months is null (lifetime), set to null. Otherwise, calculate: `new Date(Date.now() + duration_months * 30 * 24 * 60 * 60 * 1000).toISOString()`. Use a proper date calculation — add months to current date.
     - `stripe_customer_id: session.customer` (ensure stored, may already exist)
   - Log success: `console.log('Fulfilled checkout session ${session.id} for member ${member_id}')`
   - Return void on success, throw on unrecoverable error

2. Update `src/app/api/webhooks/stripe/route.ts`:
   - Import `fulfillCheckoutSession` from `@/lib/actions/fulfillment`
   - Replace the placeholder `checkout.session.completed` case:
     ```
     case 'checkout.session.completed': {
       const session = event.data.object as Stripe.Checkout.Session;
       await fulfillCheckoutSession(session);
       break;
     }
     ```
   - Keep the existing error handling pattern (catch in outer try, still return 200)
   - No changes to other event handlers (payment_intent.succeeded/failed remain as-is for now)

**Important:** Do NOT import from `next/headers` or use `cookies()` in fulfillment.ts — it runs in webhook context with no user session. Only use admin client.
  </action>
  <verify>npx tsc --noEmit passes, webhook route compiles without errors</verify>
  <done>Webhook handler calls fulfillCheckoutSession on checkout.session.completed, fulfillment updates payment status and member fields idempotently</done>
</task>

<task type="auto">
  <name>Task 2: Create checkout success and cancel pages</name>
  <files>src/app/member/(portal)/checkout/success/page.tsx, src/app/member/(portal)/checkout/cancel/page.tsx</files>
  <action>
1. Create `src/app/member/(portal)/checkout/success/page.tsx`:
   - Server component that reads `searchParams.session_id` from URL
   - Call `getPaymentBySessionId(sessionId)` to get payment details
   - If payment found and status is 'succeeded': show success state with:
     - Green checkmark icon
     - "Payment Successful!" heading
     - Payment details: amount (format cents to dollars), membership type, date
     - "Back to Dashboard" link → /member
     - "View Payment History" link → /member/payments
   - If payment found but status is 'pending': show processing state with:
     - Clock/spinner icon
     - "Payment Processing" heading
     - "Your payment is being processed. This usually takes a moment."
     - "Back to Dashboard" link
   - If no payment found or no session_id: show generic success with:
     - "Thank you for your payment!"
     - "Back to Dashboard" link
   - Use the existing dark western theme: navy-800 cards, white text, gold-500 accents
   - Follow the portal page patterns (similar to profile page layout)

2. Create `src/app/member/(portal)/checkout/cancel/page.tsx`:
   - Simple server component, no data fetching needed
   - Show:
     - X-circle icon (red/amber)
     - "Payment Cancelled" heading
     - "Your payment was not processed. No charges were made."
     - "Try Again" link → /member/pay-dues
     - "Back to Dashboard" link → /member
   - Same theme styling as success page
  </action>
  <verify>npm run build succeeds, both pages render without errors at their routes</verify>
  <done>Success page shows payment confirmation with details from payments table, cancel page shows cancellation with retry link, both use portal layout</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds without errors
- [ ] Webhook handler imports and calls fulfillment function
- [ ] Fulfillment handles idempotency (duplicate webhook calls)
- [ ] Success page reads session_id from URL and displays payment info
- [ ] Cancel page provides retry link
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Webhook fulfillment updates both payments and members tables
- Checkout success/cancel pages render correctly within portal layout
</success_criteria>

<output>
After completion, create `.planning/phases/17-membership-payments/17-02-SUMMARY.md`
</output>
