---
phase: 17-membership-payments
plan: 03
type: execute
depends_on: ["17-01"]
files_modified: [src/app/member/(portal)/pay-dues/page.tsx, src/components/CheckoutButton.tsx, src/app/member/(portal)/payments/page.tsx, src/app/member/(portal)/page.tsx, src/lib/member-navigation.ts]
domain: null
---

<objective>
Build the member-facing payment UI: pay dues page with membership type selection, updated payment history with real data, and dashboard renewal CTA.

Purpose: Give members a complete self-service payment experience — select a membership type, pay via Stripe, and view their payment history.
Output: Pay dues page with checkout integration, payment history with real data, dashboard with renewal prompts.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Prior plan in this phase:
@.planning/phases/17-membership-payments/17-01-SUMMARY.md

# Key source files:
@src/app/member/(portal)/page.tsx
@src/app/member/(portal)/payments/page.tsx
@src/lib/member-navigation.ts
@src/lib/actions/checkout.ts
@src/lib/actions/payments.ts
@src/lib/actions/membership-types.ts
@src/lib/actions/members.ts
@src/types/database.ts
@src/app/membership/page.tsx

**Tech stack available:** stripe, @stripe/stripe-js, @stripe/react-stripe-js
**Established patterns:**
- Member portal pages: server components in src/app/member/(portal)/
- Client components: 'use client' with useTransition for server action calls (ProfileForm pattern)
- Navigation: member-navigation.ts with icon, label, href, description
- Membership type display: price formatting (priceCents / 100).toFixed(2), duration label
- Dark western theme: navy-800 cards, navy-700 borders, white headings, gray-400 body, gold-500 accents
- Status badges: green for active, yellow for pending, red for expired/suspended

**Constraining decisions:**
- Phase 16: price_cents integer, loosely coupled via slug
- Phase 15: (portal) route group for authenticated member routes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pay-dues page with membership type selection and checkout button</name>
  <files>src/app/member/(portal)/pay-dues/page.tsx, src/components/CheckoutButton.tsx, src/lib/member-navigation.ts</files>
  <action>
1. Create `src/components/CheckoutButton.tsx` — client component:
   - `'use client'` directive
   - Props: `{ membershipTypeSlug: string; label?: string; className?: string }`
   - Uses `useState` for loading state, `useTransition` or plain async handler
   - On click: call `createCheckoutSession(membershipTypeSlug)` server action
   - If result has `url`: redirect via `window.location.href = result.url`
   - If result has `error`: show inline error message below button
   - Show loading spinner/text while processing ("Processing..." text)
   - Disabled state while loading
   - Default styling: gold-500 background, navy-900 text, rounded-lg, hover state (follow "Join Now" button pattern from membership page)

2. Create `src/app/member/(portal)/pay-dues/page.tsx` — server component:
   - Fetch member profile via `getMemberProfile()`
   - Fetch active membership types via `getActiveMembershipTypes()`
   - **Header section:**
     - If member status is 'active': "Renew Your Membership" heading
     - If member status is 'pending' or 'expired': "Pay Membership Dues" heading
     - Subtitle explaining the action
   - **Current membership info** (if member has active/expired membership):
     - Show current type, status badge, expiry date
   - **Membership type cards** (grid layout matching public membership page):
     - Each card shows: name, price (formatted as $XX.XX), duration (/year or One-time), description, benefits list
     - CheckoutButton at bottom of each card
     - If member has a current membership_type, highlight that card with a "Current Plan" badge and label the button "Renew" instead of "Pay Now"
     - Other cards show "Switch to [Type]" or "Select [Type]"
   - Style: navy-800 cards, navy-700 borders, gold-500 accents, responsive grid (1-col mobile, 2-col md, 4-col lg if 4 types)

3. Update `src/lib/member-navigation.ts`:
   - Add "Pay Dues" nav item after "My Profile" and before "Payment History":
     ```
     {
       label: 'Pay Dues',
       href: '/member/pay-dues',
       icon: BanknotesIcon, // from @heroicons/react/24/outline
       description: 'Pay or renew membership dues',
     }
     ```
   - Import BanknotesIcon from @heroicons/react/24/outline
  </action>
  <verify>npm run build succeeds, pay-dues page renders with membership type cards and checkout buttons</verify>
  <done>Pay-dues page shows membership types with working CheckoutButton components, navigation updated with Pay Dues item</done>
</task>

<task type="auto">
  <name>Task 2: Update payment history page and dashboard with real payment data</name>
  <files>src/app/member/(portal)/payments/page.tsx, src/app/member/(portal)/page.tsx</files>
  <action>
1. Update `src/app/member/(portal)/payments/page.tsx`:
   - Convert from static empty state to data-driven server component
   - Call `getMemberPayments()` to fetch payment records
   - **If payments exist:** Show a table/list with columns:
     - Date (formatted from created_at)
     - Description (from description field)
     - Amount (format price_cents to $XX.XX)
     - Status (badge: green for succeeded, yellow for pending, red for failed, blue for refunded)
     - Type (membership_dues or membership_renewal, humanized)
   - Use responsive design: table on desktop, stacked cards on mobile
   - **If no payments:** Keep the existing empty state but update the CTA link to point to `/member/pay-dues` instead of `/membership`
   - Style: navy-800 table/cards, navy-700 borders, matching the portal aesthetic

2. Update `src/app/member/(portal)/page.tsx` (dashboard):
   - **Replace the renewal placeholder** (lines ~138-145 that show "Renewal will be available soon"):
     - If member status is 'expired': Show amber/red banner "Your membership has expired" with "Renew Now" link → /member/pay-dues
     - If member status is 'pending': Show info banner "Complete your membership payment" with "Pay Dues" link → /member/pay-dues
     - If member status is 'active' and membership_expiry is within 30 days: Show gentle reminder "Your membership expires on [date]" with "Renew Early" link → /member/pay-dues
     - If member status is 'active' and not expiring soon: Show green "Membership active" with expiry date (no action needed)
   - **Update Payment History Preview** (bottom section, lines ~216-227):
     - Call `getMemberPayments()` and show last 3 payments in a compact list
     - Each row: date, description, amount, status badge
     - If no payments: keep existing empty state
     - "View All" link → /member/payments
   - Import `getMemberPayments` from `@/lib/actions/payments`
  </action>
  <verify>npm run build succeeds, dashboard shows renewal CTA for expired/pending members, payment history shows real data when payments exist</verify>
  <done>Payment history page displays real payment data with status badges, dashboard shows contextual renewal CTAs and recent payments preview</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete membership payment flow: pay-dues page → Stripe Checkout → webhook fulfillment → payment history. Includes dashboard renewal prompts, payment history with real data, and checkout success/cancel pages.</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Ensure Stripe webhook listener is running: stripe listen --forward-to localhost:3000/api/webhooks/stripe
    3. Ensure migration 006_payments.sql has been applied in Supabase Dashboard
    4. Ensure SUPABASE_SERVICE_ROLE_KEY is set in .env.local
    5. Log in as a member at /member/login
    6. Navigate to Pay Dues (/member/pay-dues)
    7. Verify: Membership type cards display with prices and checkout buttons
    8. Click "Pay Now" on a membership type
    9. Verify: Redirected to Stripe Checkout page
    10. Use test card: 4242 4242 4242 4242, any future expiry, any CVC
    11. Complete payment
    12. Verify: Redirected to success page with payment confirmation
    13. Navigate to Dashboard (/member)
    14. Verify: Membership status shows "active" with correct type and dates
    15. Verify: Payment history preview shows the recent payment
    16. Navigate to Payment History (/member/payments)
    17. Verify: Full payment record visible with amount, date, status
    18. Test cancel flow: Start another checkout, click back/cancel
    19. Verify: Cancel page shows with retry link
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds without errors
- [ ] Pay-dues page shows membership types with checkout buttons
- [ ] Checkout flow redirects to Stripe and back
- [ ] Webhook fulfillment updates member status and payment record
- [ ] Payment history page shows real payment data
- [ ] Dashboard shows contextual renewal/payment CTAs
- [ ] Phase 17 complete
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Members can pay dues via Stripe Checkout
- Payment history shows real transactions
- Dashboard prompts renewal when appropriate
- Phase 17 complete
</success_criteria>

<output>
After completion, create `.planning/phases/17-membership-payments/17-03-SUMMARY.md`
</output>
