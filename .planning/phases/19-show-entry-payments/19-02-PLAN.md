---
phase: 19-show-entry-payments
plan: 02
type: execute
depends_on: ["19-01"]
files_modified: [src/app/member/(portal)/entries/PayEntryButton.tsx, src/app/member/(portal)/entries/page.tsx, src/app/member/(portal)/checkout/cancel/page.tsx, src/app/member/(portal)/checkout/success/page.tsx, src/app/member/(portal)/enter-show/ShowEntryForm.tsx]
---

<objective>
Wire up the entry payment UI: a "Pay Now" button on draft entries, context-aware checkout success/cancel pages, and a "Save & Pay" option on the entry form.

Purpose: Complete the member-facing payment experience for show entries.
Output: Working end-to-end entry payment flow from entries list or entry form through Stripe to confirmation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-show-entry-payments/19-01-SUMMARY.md

# Key source files:
@src/app/member/(portal)/entries/page.tsx
@src/app/member/(portal)/entries/CancelEntryButton.tsx
@src/app/member/(portal)/enter-show/ShowEntryForm.tsx
@src/app/member/(portal)/checkout/success/page.tsx
@src/app/member/(portal)/checkout/cancel/page.tsx
@src/lib/actions/entry-checkout.ts
@src/types/database.ts

**Tech stack available:** Next.js 16, Tailwind CSS v4, Heroicons
**Established patterns:**
- Client components for interactive buttons (CancelEntryButton pattern)
- Server actions called from client components
- Status badge coloring: draft=gray, pending_payment=yellow, confirmed=green, cancelled=red
- Multi-step form with gold accent colors and navy card backgrounds
- Checkout success page with three states (succeeded, pending, generic)

**Constraining decisions:**
- Phase 18: "Pay Now" placeholder in entries list ready for activation
- Phase 18: Entries saved as draft; payment integration deferred to Phase 19
- Phase 17: Checkout success/cancel page patterns established
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PayEntryButton and update entries list and cancel page</name>
  <files>src/app/member/(portal)/entries/PayEntryButton.tsx, src/app/member/(portal)/entries/page.tsx, src/app/member/(portal)/checkout/cancel/page.tsx</files>
  <action>
**PayEntryButton.tsx** — New client component following CancelEntryButton.tsx patterns:
- 'use client' directive
- Props: `{ entryIds: string[] }` (supports single or multiple entries)
- State: loading boolean, error string | null
- On click: call `createEntryCheckoutSession(entryIds)` from `@/lib/actions/entry-checkout`
  - If result has `url`: redirect via `window.location.href = url` (external Stripe redirect, NOT router.push)
  - If result has `error`: set error state, show inline error message
- Render: Gold-styled button text "Pay Now" (text-gold-500 hover:text-gold-400 text-xs font-medium transition-colors). Show "Processing..." when loading. Show small red error text below if error.
- Disabled while loading.

**entries/page.tsx** — Replace placeholder "Pay Now" spans:
- Import PayEntryButton
- In EntryTableRow: Replace the `<span className="cursor-not-allowed text-xs text-slate-500" title="Payment coming soon">Pay Now</span>` with `<PayEntryButton entryIds={[entry.id]} />`. Show PayEntryButton for BOTH 'draft' AND 'pending_payment' status entries (pending_payment allows retry if previous checkout was abandoned).
- In EntryCard: Same replacement — replace the placeholder span with `<PayEntryButton entryIds={[entry.id]} />` for draft and pending_payment entries.
- Keep CancelEntryButton only for 'draft' entries (already correct).

**checkout/cancel/page.tsx** — Make context-aware:
- Accept `searchParams` prop: `Promise<{ return?: string }>`
- Parse `return` param
- If return === 'entries': "Try Again" links to `/member/entries` with text "Return to My Entries"
- Default (no return param or return === 'dues'): Keep existing behavior linking to `/member/pay-dues`
- Keep "Back to Dashboard" link unchanged
  </action>
  <verify>npx tsc --noEmit passes. npm run build succeeds. Grep entries/page.tsx for 'PayEntryButton' to confirm integration. Grep cancel/page.tsx for 'entries' to confirm conditional.</verify>
  <done>PayEntryButton component created. Entries list shows working "Pay Now" for draft and pending_payment entries. Cancel page shows context-appropriate return link. No TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Update checkout success page and add save-and-pay to entry form</name>
  <files>src/app/member/(portal)/checkout/success/page.tsx, src/app/member/(portal)/enter-show/ShowEntryForm.tsx</files>
  <action>
**checkout/success/page.tsx** — Make messaging context-aware based on payment_type:
- In the "succeeded" state block (line 88+):
  - Check `payment.payment_type`:
    - If 'entry_fees': Change subtitle to "Your show entries have been confirmed. Thank you!" (instead of "Your membership has been activated.")
    - If membership (default): Keep existing text
  - In the action links section: If payment_type is 'entry_fees', replace "View Payment History" link with a "View My Entries" link to `/member/entries`. Keep "Back to Dashboard" link.
  - The payment details card: If payment_type is 'entry_fees', hide the "Membership" row (it shows membership_type_slug which is null for entries). Instead show payment description if available.
- In the "pending" state block (line 158+):
  - Similar: If payment_type is 'entry_fees', change text from "Your membership will be activated" to "Your entries will be confirmed once the payment is processed."
- The generic state (no session_id) remains unchanged.

**ShowEntryForm.tsx** — Add "Save & Pay Now" option on step 3:
- Import `createEntryCheckoutSession` from `@/lib/actions/entry-checkout`
- Add new state: `payAfterSave: boolean` (default false), `payError: string | null`
- In step 3 (Review & Save), add a second button alongside "Save Entries":
  - "Save & Pay Now" button (bg-gold-500, same styling as Save but more prominent)
  - "Save as Draft" button (bg-navy-700, secondary styling)
- Modify handleSave to accept a `payImmediately: boolean` parameter:
  - After successful save (createShowEntries returns entries), if `payImmediately`:
    - Extract entry IDs from the returned entries
    - Call `createEntryCheckoutSession(entryIds)`
    - If result has `url`: redirect via `window.location.href = url`
    - If result has `error`: set payError state, still redirect to entries list (entries saved as draft)
  - If NOT payImmediately: Keep existing behavior (redirect to /member/entries?success=...)
- Update the draft notice text: "Your entries will be saved and you'll be redirected to Stripe to complete payment." when "Save & Pay Now" is selected. Keep existing draft notice for "Save as Draft."
- Button labels while submitting: "Redirecting to Payment..." for pay flow, "Saving..." for draft flow.
  </action>
  <verify>npx tsc --noEmit passes. npm run build succeeds. Grep success/page.tsx for 'entry_fees' to confirm conditional messaging. Grep ShowEntryForm.tsx for 'createEntryCheckoutSession' to confirm integration.</verify>
  <done>Checkout success page shows entry-specific messaging for entry_fees payments. ShowEntryForm offers "Save & Pay Now" that saves entries then redirects to Stripe checkout. No TypeScript errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete show entry payment flow: Pay Now on entries list, Save & Pay on entry form, Stripe checkout, confirmation with context-aware success/cancel pages</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Log in as a member at /member/login
    3. Navigate to /member/enter-show
    4. Select a show, add a horse/rider entry, select classes
    5. On step 3, verify TWO buttons: "Save as Draft" and "Save & Pay Now"
    6. Click "Save as Draft" — verify redirect to /member/entries with draft status entry
    7. On the entries list, verify "Pay Now" button appears for draft entry (gold text, not disabled)
    8. Go back to /member/enter-show, create another entry
    9. Click "Save & Pay Now" — verify redirect to Stripe Checkout with correct line items
    10. Use Stripe test card (4242424242424242) to complete payment
    11. Verify redirect to success page with "Your show entries have been confirmed" message
    12. Verify the entry status changed to "confirmed" on /member/entries
    13. Test cancel flow: Create entry, click Pay Now, cancel at Stripe, verify cancel page links to "Return to My Entries"
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds without errors
- [ ] Pay Now button works on draft entries in entries list
- [ ] Save & Pay Now creates entries and redirects to Stripe
- [ ] Checkout success page shows entry-specific confirmation
- [ ] Cancel page shows context-appropriate return link
- [ ] Entry status updates from draft → confirmed after payment
- [ ] Existing membership payment flow still works correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors or warnings introduced
- End-to-end entry payment works: create entry → pay via Stripe → confirmed status
- Both "Pay Now" (entries list) and "Save & Pay Now" (entry form) flows work
- Checkout success/cancel pages handle both membership and entry payment contexts
- Phase 19 complete
</success_criteria>

<output>
After completion, create `.planning/phases/19-show-entry-payments/19-02-SUMMARY.md`
</output>
