---
phase: 19-show-entry-payments
plan: 01
type: execute
depends_on: []
files_modified: [src/lib/actions/entry-checkout.ts, src/lib/actions/fulfillment.ts]
---

<objective>
Create the server-side payment flow for show entries: a checkout session action that builds multi-line-item Stripe Checkout from draft entries, and webhook fulfillment that confirms entries on payment success.

Purpose: Enable members to pay for show entry fees via Stripe, completing the draft→confirmed lifecycle.
Output: `createEntryCheckoutSession` server action and extended webhook fulfillment handler.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (payment + entry patterns):
@.planning/phases/17-membership-payments/17-01-SUMMARY.md
@.planning/phases/17-membership-payments/17-02-SUMMARY.md
@.planning/phases/18-show-entry-system/18-03-SUMMARY.md

# Key source files:
@src/lib/actions/checkout.ts
@src/lib/actions/fulfillment.ts
@src/lib/actions/show-entries.ts
@src/lib/actions/payments.ts
@src/lib/supabase/admin.ts
@src/lib/stripe/server.ts
@src/types/database.ts
@src/app/api/webhooks/stripe/route.ts

**Tech stack available:** Next.js 16, Supabase, Stripe SDK, admin client pattern
**Established patterns:**
- Checkout flow: authenticate → validate → create/retrieve Stripe customer → create session → insert pending payment → return URL
- Webhook fulfillment: idempotency check → update payment → update domain records → log
- Admin client for all writes (bypasses RLS)
- Payment type in metadata for fulfillment dispatch
- fee_cents snapshot pattern on show_entry_classes

**Constraining decisions:**
- Phase 17: Payments SELECT-only RLS; all writes via service role admin client
- Phase 17: Idempotent webhook fulfillment with fallback payment creation
- Phase 18: show_entries.payment_id nullable FK ready for Phase 19
- Phase 18: Entry status CHECK constraint: draft, pending_payment, confirmed, cancelled
- Phase 18: Entry writes via service role admin client
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create entry checkout session server action</name>
  <files>src/lib/actions/entry-checkout.ts</files>
  <action>
Create `createEntryCheckoutSession(entryIds: string[])` server action following the established checkout pattern from `src/lib/actions/checkout.ts`.

Flow:
1. Validate input: entryIds non-empty, each trimmed and non-blank
2. Authenticate user via `createClient()` + `getUser()`
3. Fetch member profile for Stripe customer creation/reuse (same pattern as checkout.ts)
4. Fetch entries via admin client: SELECT from show_entries WHERE id IN (entryIds) AND member_id = user.id AND status IN ('draft', 'pending_payment'). Verify all entries found (count matches input length). Verify all entries share the same show_id.
5. Fetch show name from shows table for the shared show_id (for line item descriptions)
6. Fetch entry classes via admin client: SELECT from show_entry_classes WHERE entry_id IN (entryIds). Group by entry_id. Also fetch class names from show_classes for descriptions.
7. Create or retrieve Stripe customer (exact same pattern as checkout.ts lines 102-129)
8. Build Stripe Checkout Session:
   - mode: 'payment'
   - customer: customerId
   - line_items: One per entry. Each line item:
     - price_data.currency: 'usd'
     - price_data.unit_amount: entry's total_cents
     - price_data.product_data.name: `${entry.horse_name} / ${entry.rider_name}`
     - price_data.product_data.description: comma-separated class names for that entry
     - quantity: 1
   - metadata: { member_id, payment_type: 'entry_fees', entry_ids: comma-separated entry IDs, show_id }
   - success_url: `${appUrl}/member/checkout/success?session_id={CHECKOUT_SESSION_ID}`
   - cancel_url: `${appUrl}/member/checkout/cancel?return=entries`
9. Insert pending payment record via admin client:
   - member_id, amount_cents (sum of all entries' total_cents), payment_type: 'entry_fees', membership_type_slug: null, stripe_checkout_session_id: session.id, status: 'pending', description: `SWMRHA Show Entry Fees - ${showName}`
   Best-effort (same pattern as checkout.ts lines 168-186)
10. Update entries status to 'pending_payment' via admin client (best-effort, non-blocking error)
11. Revalidate entry paths: /member/entries, /member/enter-show
12. Return { url: session.url }

Error handling: Follow checkout.ts patterns — sanitizeSupabaseError helper, try/catch wrapper, user-friendly error messages. Return `{ error: string }` on failure.

Do NOT mark this as 'use server' directive pattern — it IS a server action file, so include 'use server' at top.
  </action>
  <verify>npx tsc --noEmit passes. npm run build succeeds.</verify>
  <done>createEntryCheckoutSession exported, accepts entry IDs, creates multi-line-item Stripe Checkout, inserts pending payment, updates entry status. TypeScript compiles clean.</done>
</task>

<task type="auto">
  <name>Task 2: Extend webhook fulfillment for entry payments</name>
  <files>src/lib/actions/fulfillment.ts</files>
  <action>
Refactor `fulfillCheckoutSession` in fulfillment.ts to dispatch based on `payment_type` metadata.

Changes:
1. After the existing idempotency check (lines 26-39) and payment record update (lines 41-93), add a dispatch point based on `session.metadata?.payment_type`:

   ```
   if (paymentType === 'entry_fees') {
     await fulfillEntryPayment(session, admin, paymentRecord);
   } else {
     // existing membership fulfillment logic (lines 96-163)
   }
   ```

2. Extract existing membership fulfillment (lines 96-163) into a helper function `fulfillMembershipPayment(session, admin)` to keep the main function clean.

3. Create `fulfillEntryPayment(session, admin, paymentId)`:
   a. Parse `entry_ids` from metadata (comma-separated string → array)
   b. If no entry_ids in metadata, log error and return
   c. Get the payment record ID. If payment was updated (from step 2 of main function), use that ID. If fallback was created, use that ID. Pass this as a parameter.
   d. For each entry_id: UPDATE show_entries SET status = 'confirmed', payment_id = paymentRecordId WHERE id = entry_id (via admin client)
   e. Log any individual entry update failures but continue processing remaining entries
   f. Revalidate paths: /member/entries, /member/enter-show, /admin/shows

4. Update the payment record update section (lines 41-93) to capture the payment record ID (either from update or fallback insert) so it can be passed to entry fulfillment. The existing `updatedPayment` already returns `id` via `.select('id')`. For fallback inserts, add `.select('id').single()` to capture the new record ID.

5. For the fallback payment creation (lines 65-92): When payment_type is 'entry_fees', set membership_type_slug to null in the fallback record. The existing code uses `membershipTypeSlug` from metadata which will be undefined for entry payments — ensure this defaults to null gracefully.

Keep the function signature unchanged. Do NOT add 'use server' to this file (it runs in webhook context, not as a server action).
  </action>
  <verify>npx tsc --noEmit passes. npm run build succeeds. Grep fulfillment.ts for 'entry_fees' to confirm dispatch logic exists.</verify>
  <done>fulfillCheckoutSession dispatches based on payment_type. Entry payments update show_entries to 'confirmed' with payment_id. Membership payments work as before. TypeScript compiles clean.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds without errors
- [ ] entry-checkout.ts exports createEntryCheckoutSession
- [ ] fulfillment.ts handles both 'entry_fees' and membership payment types
- [ ] Entry checkout creates multi-line-item Stripe session (one per entry)
- [ ] Webhook fulfillment updates entries to 'confirmed' with payment_id
- [ ] All writes use admin client (service role)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Entry checkout session action follows established checkout.ts patterns
- Webhook fulfillment correctly dispatches entry vs membership payments
- Existing membership payment flow unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/19-show-entry-payments/19-01-SUMMARY.md`
</output>
