---
phase: 18-show-entry-system
plan: 01
type: execute
depends_on: []
files_modified: [supabase/migrations/007_show_classes.sql, src/types/database.ts, src/lib/actions/show-classes.ts, src/lib/admin-navigation.ts]
domain: null
---

<objective>
Create show_classes database table with per-show class definitions and pricing, plus CRUD server actions for admin management.

Purpose: Establish the data layer for show classes that enables entry selection (members) and class management (admins).
Output: Migration for show_classes table, TypeScript types, CRUD server actions, admin navigation update.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (shows + payments infrastructure):
@.planning/phases/10-show-schedule-management/10-01-SUMMARY.md
@.planning/phases/17-membership-payments/17-01-SUMMARY.md

# Key source files:
@supabase/migrations/001_shows.sql
@src/types/database.ts
@src/lib/actions/shows.ts
@src/lib/actions/membership-types.ts
@src/lib/supabase/admin.ts
@src/lib/admin-navigation.ts

**Tech stack available:** Next.js 16, Supabase, Stripe, @supabase/ssr, @supabase/supabase-js
**Established patterns:**
- Database types: manual interfaces in `src/types/database.ts`
- Server actions: `'use server'` with `sanitizeSupabaseError`, input validation, `revalidatePath`
- Migrations: sequential numbering (001-006 used)
- RLS: public read for active rows, admin full CRUD via `auth.jwt()->'app_metadata'->>'role' = 'admin'`
- Admin client: `createAdminClient()` from `@/lib/supabase/admin` for service-role writes
- Pricing: `fee_cents` integer storage with dollar display conversion (established in membership_types)

**Constraining decisions:**
- Phase 10: Shows table uses JSONB for links/notes, sort_order for ordering
- Phase 16: price_cents integer storage pattern, slug-based loose coupling
- Phase 17: Payments SELECT-only RLS; all writes via service role admin client
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create show_classes table migration with RLS and seed data</name>
  <files>supabase/migrations/007_show_classes.sql</files>
  <action>
Create `supabase/migrations/007_show_classes.sql`:

1. Table `public.show_classes`:
   - `id` UUID DEFAULT gen_random_uuid() PRIMARY KEY
   - `show_id` UUID NOT NULL REFERENCES public.shows(id) ON DELETE CASCADE
   - `name` TEXT NOT NULL
   - `fee_cents` INTEGER NOT NULL DEFAULT 0
   - `level` TEXT — category like 'Open', 'Non Pro', 'Youth', 'Rookie' (nullable for uncategorized)
   - `sort_order` INTEGER NOT NULL DEFAULT 0
   - `is_active` BOOLEAN NOT NULL DEFAULT true
   - `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()
   - `updated_at` TIMESTAMPTZ NOT NULL DEFAULT now()

2. Enable RLS on show_classes.

3. RLS policies:
   - "Anyone can read active show classes" — SELECT for anon+authenticated WHERE is_active = true
   - "Admins can manage show classes" — ALL for authenticated WHERE auth.jwt()->'app_metadata'->>'role' = 'admin'

4. Reuse `trigger_set_updated_at()` function (already exists from migration 001) for updated_at trigger.

5. Add indexes:
   - `idx_show_classes_show_id` on show_id for filtered queries
   - UNIQUE constraint on (show_id, name) to prevent duplicate class names per show

6. Seed data — insert classes for BOTH existing shows. Use subqueries to look up show IDs by name. Classes to seed (same for both shows since they run similar classes):
   - Open Derby, 15000 cents ($150), level 'Open', sort_order 1
   - Non Pro Derby, 12500 cents ($125), level 'Non Pro', sort_order 2
   - Rookie Professional Level 1, 10000 cents ($100), level 'Rookie', sort_order 3
   - Rookie Professional Level 2, 10000 cents ($100), level 'Rookie', sort_order 4
   - Intermediate Open, 7500 cents ($75), level 'Open', sort_order 5
   - Intermediate Non Pro, 7500 cents ($75), level 'Non Pro', sort_order 6
   - Prime Time Plus Open, 7500 cents ($75), level 'Open', sort_order 7
   - Prime Time Plus Non Pro, 7500 cents ($75), level 'Non Pro', sort_order 8
   - Youth Reining, 5000 cents ($50), level 'Youth', sort_order 9

Use INSERT ... SELECT to reference show IDs:
```sql
INSERT INTO public.show_classes (show_id, name, fee_cents, level, sort_order)
SELECT s.id, v.name, v.fee_cents, v.level, v.sort_order
FROM public.shows s
CROSS JOIN (VALUES
  ('Open Derby', 15000, 'Open', 1),
  ...
) AS v(name, fee_cents, level, sort_order);
```
This seeds classes for ALL shows, which is the expected behavior (all SWMRHA shows offer the same class structure).
  </action>
  <verify>SQL syntax valid (review manually), migration numbering is 007 (sequential after 006_payments.sql)</verify>
  <done>show_classes table with RLS, indexes, unique constraint, updated_at trigger, and seed data for all shows</done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript types and CRUD server actions for show classes</name>
  <files>src/types/database.ts, src/lib/actions/show-classes.ts, src/lib/admin-navigation.ts</files>
  <action>
1. Add to `src/types/database.ts` (after PaymentRow section):

   ```
   // Show Classes table
   interface ShowClassRow {
     id: string;
     show_id: string;
     name: string;
     fee_cents: number;
     level: string | null;
     sort_order: number;
     is_active: boolean;
     created_at: string;
     updated_at: string;
   }

   type ShowClassInsert = Omit<ShowClassRow, 'id' | 'created_at' | 'updated_at'> & {
     sort_order?: number;
     is_active?: boolean;
   };
   ```

2. Create `src/lib/actions/show-classes.ts` with `'use server'` directive. Follow the same patterns as `shows.ts` and `membership-types.ts`:

   - `getShowClasses(showId: string)`: Fetch all classes for a show ordered by sort_order ASC. Use regular Supabase client (public read via RLS). Return ShowClassRow[] or { error: string }.

   - `getActiveShowClasses(showId: string)`: Fetch active classes only (is_active = true) for a show, ordered by sort_order. For public/member-facing pages.

   - `getShowClass(id: string)`: Fetch single class by ID. Return ShowClassRow | null or { error: string }.

   - `createShowClass(data: ShowClassInsert)`: Validate required fields (show_id, name — non-empty, max 200 chars). Validate fee_cents >= 0. Insert via admin client. Revalidate paths: `/admin/shows`, `/shows`, `/member/enter-show`. Return ShowClassRow or { error: string }.

   - `updateShowClass(id: string, data: Partial<ShowClassInsert>)`: Validate provided fields same as create. Update via admin client with only provided fields. Revalidate same paths. Return ShowClassRow or { error: string }.

   - `deleteShowClass(id: string)`: Delete via admin client. Revalidate same paths. Return { success: boolean } or { error: string }.

   Use sanitizeSupabaseError for all DB errors. Handle unique constraint violation (23505) with "A class with this name already exists for this show".

3. Update `src/lib/admin-navigation.ts`: No changes needed — classes are accessed via the show detail page, not as a top-level admin nav item.
  </action>
  <verify>npx tsc --noEmit passes, all 6 action functions exported from show-classes.ts</verify>
  <done>ShowClassRow and ShowClassInsert types in database.ts, 6 server actions (get/getActive/getSingle/create/update/delete) in show-classes.ts, all type-safe</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds without errors
- [ ] ShowClassRow interface matches migration schema
- [ ] All 6 CRUD actions exported and importable
- [ ] Migration uses correct sequential number (007)
- [ ] RLS policies follow established patterns (public read active, admin full CRUD)
- [ ] fee_cents integer pattern consistent with membership_types
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- show_classes migration ready for Supabase Dashboard execution
- Server actions ready for admin UI integration
- Types ready for member entry UI integration
</success_criteria>

<output>
After completion, create `.planning/phases/18-show-entry-system/18-01-SUMMARY.md`
</output>
