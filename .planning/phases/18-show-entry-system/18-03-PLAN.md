---
phase: 18-show-entry-system
plan: 03
type: execute
depends_on: ["18-01"]
files_modified: [supabase/migrations/008_show_entries.sql, src/types/database.ts, src/lib/actions/show-entries.ts]
domain: null
---

<objective>
Create show_entries and show_entry_classes database tables with server actions for creating, reading, and managing show entries.

Purpose: Establish the data layer for members to submit horse/rider entries with class selections, preparing for payment integration in Phase 19.
Output: Migration for entry tables, TypeScript types, server actions for entry CRUD.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Prior plan in this phase:
@.planning/phases/18-show-entry-system/18-01-SUMMARY.md

# Key source files:
@supabase/migrations/004_members_table.sql
@supabase/migrations/006_payments.sql
@src/types/database.ts
@src/lib/actions/payments.ts
@src/lib/actions/checkout.ts
@src/lib/supabase/admin.ts
@src/lib/supabase/server.ts

**Tech stack available:** Next.js 16, Supabase, @supabase/ssr, @supabase/supabase-js
**Established patterns:**
- Payments table: SELECT-only RLS for users, all writes via admin client (service role)
- Server actions: authenticate via createClient(), write via createAdminClient()
- Types: manual interfaces in database.ts matching migration schema
- Fee storage: fee_cents integer pattern

**Constraining decisions:**
- Phase 17: Payments SELECT-only RLS; all writes via service role admin client
- Phase 17: payment_type CHECK constraint currently allows 'membership_dues', 'membership_renewal' — Phase 19 will add 'show_entry'
- Phase 18-01: show_classes table with fee_cents, show_id FK to shows
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create show_entries and show_entry_classes table migration with RLS</name>
  <files>supabase/migrations/008_show_entries.sql</files>
  <action>
Create `supabase/migrations/008_show_entries.sql`:

1. Table `public.show_entries`:
   - `id` UUID DEFAULT gen_random_uuid() PRIMARY KEY
   - `show_id` UUID NOT NULL REFERENCES public.shows(id) ON DELETE CASCADE
   - `member_id` UUID NOT NULL REFERENCES public.members(id) ON DELETE CASCADE
   - `horse_name` TEXT NOT NULL
   - `rider_name` TEXT NOT NULL
   - `status` TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'pending_payment', 'confirmed', 'cancelled'))
   - `total_cents` INTEGER NOT NULL DEFAULT 0 — sum of selected class fees at time of entry
   - `payment_id` UUID REFERENCES public.payments(id) ON DELETE SET NULL — populated by Phase 19 when payment is made
   - `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()
   - `updated_at` TIMESTAMPTZ NOT NULL DEFAULT now()

2. Table `public.show_entry_classes` (junction table):
   - `id` UUID DEFAULT gen_random_uuid() PRIMARY KEY
   - `entry_id` UUID NOT NULL REFERENCES public.show_entries(id) ON DELETE CASCADE
   - `class_id` UUID NOT NULL REFERENCES public.show_classes(id) ON DELETE CASCADE
   - `fee_cents` INTEGER NOT NULL — snapshot of class fee at entry time (in case admin changes price later)
   - `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()
   - UNIQUE(entry_id, class_id) — prevent duplicate class selection per entry

3. Enable RLS on both tables.

4. RLS for show_entries:
   - "Members can read own entries" — SELECT for authenticated WHERE member_id = auth.uid()
   - "Admins can read all entries" — SELECT for authenticated WHERE auth.jwt()->'app_metadata'->>'role' = 'admin'
   - No INSERT/UPDATE/DELETE policies for regular users — all writes via service role admin client

5. RLS for show_entry_classes:
   - "Members can read own entry classes" — SELECT for authenticated WHERE entry_id IN (SELECT id FROM show_entries WHERE member_id = auth.uid())
   - "Admins can read all entry classes" — SELECT for authenticated WHERE auth.jwt()->'app_metadata'->>'role' = 'admin'
   - No INSERT/UPDATE/DELETE for regular users — writes via service role

6. Indexes:
   - `idx_show_entries_show_id` on show_entries(show_id)
   - `idx_show_entries_member_id` on show_entries(member_id)
   - `idx_show_entries_payment_id` on show_entries(payment_id)
   - `idx_show_entry_classes_entry_id` on show_entry_classes(entry_id)

7. Updated_at trigger on show_entries reusing `trigger_set_updated_at()`.
  </action>
  <verify>SQL syntax valid, migration numbering is 008 (sequential after 007_show_classes.sql)</verify>
  <done>show_entries and show_entry_classes tables with RLS, indexes, unique constraints, updated_at trigger, payment_id FK for Phase 19</done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript types and server actions for show entries</name>
  <files>src/types/database.ts, src/lib/actions/show-entries.ts</files>
  <action>
1. Add to `src/types/database.ts` (after ShowClassRow/ShowClassInsert):

   ```
   // Show Entries table
   interface ShowEntryRow {
     id: string;
     show_id: string;
     member_id: string;
     horse_name: string;
     rider_name: string;
     status: string;
     total_cents: number;
     payment_id: string | null;
     created_at: string;
     updated_at: string;
   }

   // Show Entry Classes junction table
   interface ShowEntryClassRow {
     id: string;
     entry_id: string;
     class_id: string;
     fee_cents: number;
     created_at: string;
   }

   // Composite type for entry with its selected classes
   interface ShowEntryWithClasses extends ShowEntryRow {
     classes: ShowEntryClassRow[];
   }

   // Input type for creating entries (batch: one or more horse/rider combos with class selections)
   interface CreateShowEntryInput {
     show_id: string;
     horse_name: string;
     rider_name: string;
     class_ids: string[];
   }
   ```

2. Create `src/lib/actions/show-entries.ts` with `'use server'` directive:

   **getMemberEntries():**
   - Authenticate user via createClient()
   - Query show_entries WHERE member_id = auth.uid(), ordered by created_at DESC
   - For each entry, also fetch show_entry_classes WHERE entry_id = entry.id
   - Also JOIN/fetch show name for display: query shows table for the show_id
   - Return enriched array with show name and classes, or { error: string }

   **getMemberEntriesForShow(showId: string):**
   - Authenticate, fetch entries for this member + show combo
   - Include classes for each entry
   - Return ShowEntryWithClasses[] or { error: string }

   **getShowEntries(showId: string):**
   - Admin-only: fetch ALL entries for a show (used by admin views in Phase 21)
   - Use admin client to bypass member-only RLS
   - Include classes and member name for each entry
   - Return array or { error: string }

   **createShowEntries(entries: CreateShowEntryInput[]):**
   - Authenticate user
   - Validate: entries array non-empty, each entry has show_id, horse_name (non-empty, max 200 chars), rider_name (non-empty, max 200 chars), class_ids (non-empty array)
   - All entries must have the same show_id (one show per submission)
   - Fetch active show classes for the show_id to validate class_ids exist and get fee_cents
   - Calculate total_cents for each entry: sum of fee_cents from selected classes
   - Use admin client for writes:
     - For each entry: INSERT into show_entries (show_id, member_id, horse_name, rider_name, total_cents, status='draft')
     - For each entry's classes: INSERT into show_entry_classes (entry_id, class_id, fee_cents snapshot)
   - Revalidate paths: `/member/entries`, `/member/enter-show`, `/admin/shows`
   - Return created entries or { error: string }

   **cancelShowEntry(entryId: string):**
   - Authenticate user
   - Verify entry belongs to current member (query show_entries WHERE id AND member_id)
   - Only allow cancellation if status is 'draft' (not 'confirmed' or 'pending_payment')
   - Update status to 'cancelled' via admin client
   - Revalidate paths
   - Return { success: boolean } or { error: string }

   Use sanitizeSupabaseError for all DB errors. Wrap writes in try/catch with meaningful error messages.
  </action>
  <verify>npx tsc --noEmit passes, all 5 action functions exported from show-entries.ts</verify>
  <done>ShowEntryRow, ShowEntryClassRow, ShowEntryWithClasses, CreateShowEntryInput types in database.ts. 5 server actions (getMemberEntries, getMemberEntriesForShow, getShowEntries, createShowEntries, cancelShowEntry) in show-entries.ts, all type-safe</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds without errors
- [ ] ShowEntryRow and ShowEntryClassRow interfaces match migration schema
- [ ] All 5 actions exported and importable
- [ ] Migration uses correct sequential number (008)
- [ ] RLS follows payments pattern (SELECT-only for users, writes via admin client)
- [ ] Entry creation validates class_ids against active show_classes
- [ ] fee_cents snapshot captured in show_entry_classes at creation time
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- show_entries and show_entry_classes migrations ready for Supabase Dashboard
- Server actions ready for member entry UI integration
- Entry creation properly snapshots class fees and calculates totals
- payment_id column ready for Phase 19 integration
</success_criteria>

<output>
After completion, create `.planning/phases/18-show-entry-system/18-03-SUMMARY.md`
</output>
