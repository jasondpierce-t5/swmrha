---
phase: 15-member-portal-profiles
plan: 01
type: execute
depends_on: []
files_modified: [src/components/MemberLayoutShell.tsx, src/components/MemberSidebar.tsx, src/components/MemberHeader.tsx, src/app/member/layout.tsx, src/app/member/page.tsx, src/components/LayoutWrapper.tsx, src/types/database.ts, src/lib/actions/members.ts]
---

<objective>
Build the member portal shell (layout, sidebar, header) and dashboard page with live member data.

Purpose: Establish the member-facing portal structure that parallels the admin panel, giving members a dedicated space to view their profile, membership status, and navigate member features.
Output: Working member portal at /member with authenticated layout shell and dashboard showing member profile data.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 14 context (direct dependency):
@.planning/phases/14-stripe-foundation-member-auth/14-02-SUMMARY.md
@.planning/phases/14-stripe-foundation-member-auth/14-03-SUMMARY.md

# Key files to reference (existing patterns):
@src/components/AdminLayoutShell.tsx
@src/components/AdminSidebar.tsx
@src/components/AdminHeader.tsx
@src/app/admin/layout.tsx
@src/app/admin/page.tsx
@src/lib/actions/shows.ts
@src/types/database.ts
@src/components/LayoutWrapper.tsx
@supabase/migrations/004_members_table.sql

**Tech stack available:** Next.js 16, Tailwind CSS v4, Supabase SSR, Stripe SDK
**Established patterns:** AdminLayoutShell (sidebar+header), server actions with error sanitization, server component pages with auth checks, client forms with useTransition
**Constraining decisions:**
- Phase 14: Members table uses auth.users id as PK (1:1), default state='MO'
- Phase 14: Member route protection requires any authenticated user (not role-specific)
- Phase 14: LayoutWrapper hides chrome on /member/login and /member/register
- Phase 9: Three-client Supabase SSR pattern (browser/server/middleware)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create member layout components and update LayoutWrapper</name>
  <files>src/components/MemberLayoutShell.tsx, src/components/MemberSidebar.tsx, src/components/MemberHeader.tsx, src/app/member/layout.tsx, src/components/LayoutWrapper.tsx, src/types/database.ts</files>
  <action>
Create the member portal layout following the admin panel pattern exactly:

**1. src/types/database.ts** — Add MemberRow type matching the members table schema:
- id (string), email, first_name, last_name, phone, address_line1, address_line2, city, state, zip
- membership_type, membership_status, membership_start (string|null), membership_expiry (string|null)
- stripe_customer_id (string|null), avatar_url (string|null), created_at, updated_at

**2. src/components/MemberSidebar.tsx** — Client component modeled on AdminSidebar:
- Navigation items: Dashboard (/member), My Profile (/member/profile), Payment History (/member/payments)
- Active state detection via pathname (same pattern as AdminSidebar)
- Fixed sidebar on desktop (lg:w-64), slide-out drawer on mobile with overlay
- "View Site" link at bottom pointing to /
- Dark western theme matching admin (bg-navy-900, border-navy-700, gold accents)
- Logout button at bottom that posts to a logout action

**3. src/components/MemberHeader.tsx** — Client component modeled on AdminHeader:
- Hamburger menu toggle (mobile), page title derived from navigation config, user name display
- Derive page title from memberNavigation array (same pattern as adminNavigation in AdminHeader)

**4. src/components/MemberLayoutShell.tsx** — Client component modeled on AdminLayoutShell:
- Composes MemberSidebar + MemberHeader + content area
- Props: userName (string), children
- Same flex layout as admin: sidebar left, content right, responsive

**5. src/app/member/layout.tsx** — Server component with auth check:
- Use createClient() from @/lib/supabase/server
- Get user via supabase.auth.getUser()
- If no user, redirect to /member/login
- Query members table for user profile (first_name + last_name for display)
- Wrap children in MemberLayoutShell with userName prop
- Add metadata: title template "Member Portal | SWMRHA"

**6. src/components/LayoutWrapper.tsx** — Update fullscreen route check:
- Change `/member/login` and `/member/register` specific checks to a single `pathname.startsWith("/member")` check
- This makes ALL /member/* routes use fullscreen (no public Header/Footer) since member portal has its own layout shell

**Logout approach:** Create a logout server action or inline form that calls supabase.auth.signOut() and redirects to /member/login. Follow the POST-based logout pattern from admin (CSRF protection via form submission). The simplest approach: add a route handler at src/app/member/logout/route.ts that handles POST, signs out, and redirects.

Also create **src/app/member/logout/route.ts** — POST handler that signs out and redirects to /member/login (mirrors admin logout pattern).
  </action>
  <verify>npm run build passes without errors. Navigating to /member while authenticated shows the portal shell with sidebar and header.</verify>
  <done>MemberLayoutShell renders with sidebar navigation, header with user name, responsive layout. LayoutWrapper excludes public chrome for all /member/* routes. Member types exported from database.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Create member dashboard page and getMemberProfile action</name>
  <files>src/lib/actions/members.ts, src/app/member/page.tsx</files>
  <action>
**1. src/lib/actions/members.ts** — Server actions following the shows.ts pattern:

```
'use server'
```

Create getMemberProfile():
- Use createClient() from @/lib/supabase/server
- Get authenticated user via supabase.auth.getUser()
- If no user, return { error: 'Not authenticated' }
- Query members table where id = user.id, .single()
- Return MemberRow or { error: string }
- Use sanitizeSupabaseError pattern from shows.ts

**2. src/app/member/page.tsx** — Server component dashboard:
- Call getMemberProfile() to get member data
- If error, show error state

Dashboard layout sections:
- **Welcome banner**: "Welcome back, {first_name}!" with membership badge (type + status)
- **Membership Status card**: Type (individual/family/youth/lifetime), Status (pending/active/expired/suspended) with color-coded badges, Expiry date if set, "Renew" link placeholder (Phase 17)
- **Profile Summary card**: Name, email, phone, city/state. "Edit Profile" link → /member/profile/edit
- **Quick Links grid**: Edit Profile, View Shows (/shows), Payment History (/member/payments), Contact Us (/contact)
- **Payment History preview**: Empty state card with message "No payment history yet. Your transactions will appear here once you make a payment." (populated in Phase 17)

Use the same card styling as admin dashboard: rounded-lg border border-navy-700 bg-navy-800 p-6. Status badges: active=green, pending=yellow, expired=red, suspended=red.
  </action>
  <verify>npm run build passes. Navigating to /member while authenticated shows dashboard with profile data from the members table. Welcome message shows member's first name.</verify>
  <done>Member dashboard renders with live data from members table. Membership status card shows type and status with appropriate badge colors. Profile summary card shows member info with edit link. Quick links grid navigates correctly.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] /member redirects to /member/login when not authenticated
- [ ] /member shows portal shell with sidebar when authenticated as member
- [ ] Dashboard displays member name, membership status, profile summary
- [ ] Sidebar navigation highlights active page
- [ ] Responsive: sidebar collapses on mobile, hamburger menu works
- [ ] Logout button signs out and redirects to /member/login
- [ ] Public Header/Footer hidden on all /member/* routes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Member portal shell matches admin panel quality
- Dashboard shows live member data from Supabase
</success_criteria>

<output>
After completion, create `.planning/phases/15-member-portal-profiles/15-01-SUMMARY.md`
</output>
