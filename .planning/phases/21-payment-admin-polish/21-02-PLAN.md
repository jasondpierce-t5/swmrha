---
phase: 21-payment-admin-polish
plan: 02
type: execute
depends_on: ["21-01"]
files_modified:
  - src/app/admin/payments/[id]/page.tsx
  - src/lib/actions/admin-payments.ts
  - src/components/RefundPaymentButton.tsx
---

<objective>
Create the payment detail view page and Stripe refund processing, then verify all admin payment features and existing payment flows work end-to-end.

Purpose: Enable admins to view detailed payment information, process refunds via Stripe, and ensure the complete payment ecosystem is solid.
Output: Payment detail page with related items, working refund flow, UAT verification of all payment flows.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summary:
@.planning/phases/21-payment-admin-polish/21-01-SUMMARY.md

# Key source files:
@src/types/database.ts
@src/lib/actions/admin-payments.ts
@src/lib/stripe/server.ts
@src/lib/actions/fulfillment.ts
@src/app/admin/payments/page.tsx
@src/components/CheckoutButton.tsx
@src/components/DeleteMemberButton.tsx

**Tech stack available:** Next.js 16 (App Router), Supabase (admin client), Stripe SDK (getStripeServer), Tailwind CSS v4
**Established patterns:**
- Admin detail pages: server component with ID param, fetch by ID, back link, structured info display
- Client action buttons: useState for loading/error, server action call, redirect on success (see CheckoutButton, DeleteMemberButton patterns)
- Stripe SDK: getStripeServer() returns singleton instance, stripe.refunds.create() for refunds
- PaymentRow statuses: pending, succeeded, failed, refunded
- Related records: show_entries (for entry_fees), fee_purchases (for additional_fees)
- Admin client (service role) for all payment writes

**Constraining decisions:**
- Phase 17: Payments writes via service role admin client only
- Phase 18: show_entry_classes.fee_cents snapshots class fee at entry time
- Phase 19: PayEntryButton supports both draft and pending_payment entries
- Phase 20: Fee purchase fulfillment via payment type dispatch
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payment detail page</name>
  <files>src/app/admin/payments/[id]/page.tsx</files>
  <action>
Create src/app/admin/payments/[id]/page.tsx as a server component. Structure:

1. **Back navigation** — Link back to /admin/payments at top ("← Back to Payments").

2. **Payment header** — Payment ID (truncated), creation date, large status badge, amount in dollars.

3. **Payment info card** — Navy-800 card with grid layout showing:
   - Payment Type (with badge)
   - Amount ($XX.XX)
   - Status (with badge)
   - Stripe Checkout Session ID (monospace, truncated with title for full)
   - Stripe Payment Intent ID (monospace, truncated with title for full)
   - Description
   - Created / Updated timestamps

4. **Payer info card** — Navy-800 card:
   - If member payment (member_id not null): Member name, email, link to /admin/members/[member_id]/edit
   - If guest payment (member_id null): Guest name, guest email, "Guest Purchase" label

5. **Related items section** — Conditional on payment_type:
   - **entry_fees**: Table of show entries (horse name, rider name, entry status, classes with fees). Use related entries from getPaymentByIdAdmin.
   - **additional_fees**: Table of fee purchases (item name, quantity, unit price, total, status). Use related fee purchases from getPaymentByIdAdmin.
   - **membership_dues / membership_renewal**: Display membership_type_slug as the plan purchased. No sub-table needed.

6. **Refund section** — If status is 'succeeded' and stripe_payment_intent_id exists, show RefundPaymentButton (built in Task 2). If status is 'refunded', show "This payment has been refunded" info box. If status is 'pending' or 'failed', show nothing.

7. **Success banner** — Show if ?success=refunded in searchParams: "Payment refunded successfully".

Use getPaymentByIdAdmin(id) from admin-payments.ts. Handle not-found with notFound() import from next/navigation. Follow the navy-800 card, border-navy-700, gold-500 heading pattern used across all admin pages.
  </action>
  <verify>npm run build succeeds; /admin/payments/[valid-id] renders payment detail with correct sections</verify>
  <done>Payment detail page renders all sections conditionally, back link works, related items display for each payment type, payer info shows member vs guest correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create refund server action and RefundPaymentButton component</name>
  <files>src/lib/actions/admin-payments.ts, src/components/RefundPaymentButton.tsx</files>
  <action>
**A. Add processRefund to admin-payments.ts:**

Create `processRefund(paymentId: string)` server action:

1. **Validate input** — paymentId required and trimmed.
2. **Fetch payment** — Use admin client to get payment by ID. Verify status is 'succeeded' (only succeeded payments can be refunded). Verify stripe_payment_intent_id exists (needed for Stripe refund).
3. **Process Stripe refund** — Call `stripe.refunds.create({ payment_intent: payment.stripe_payment_intent_id })` for a full refund. Wrap in try/catch — if Stripe returns error, return user-friendly error message. Use getStripeServer() for the Stripe instance.
4. **Update payment status** — Use admin client to update payment status to 'refunded'.
5. **Update related records** — Based on payment_type:
   - entry_fees: Update show_entries where payment_id matches to status 'refunded'
   - additional_fees: Update fee_purchases where payment_id matches to status 'refunded'
   - membership types: Do NOT auto-change membership status (admin manages separately via member edit page). Log a note that admin should review member status.
6. **Revalidate paths** — revalidatePath('/admin/payments'), revalidatePath('/admin/payments/[id]'), revalidatePath('/member') (so member portal reflects changes).
7. **Return** `{ success: true }` or `{ error: string }`.

**B. Create RefundPaymentButton component (src/components/RefundPaymentButton.tsx):**

Client component ('use client') following DeleteMemberButton pattern:
- Props: `paymentId: string`, `amount: string` (formatted dollar amount for display)
- Confirmation dialog: "Are you sure you want to refund $XX.XX? This will issue a full refund via Stripe and cannot be undone."
- Use window.confirm() for simplicity (matching existing delete button pattern)
- On confirm: call processRefund(paymentId), show loading state, redirect to /admin/payments/[id]?success=refunded on success, show inline error on failure
- Red/danger styling: red-600 bg with white text for the button, matching the destructive action pattern
  </action>
  <verify>npx tsc --noEmit passes; npm run build succeeds; RefundPaymentButton renders on succeeded payments in detail view</verify>
  <done>processRefund action handles Stripe refund + DB updates for all payment types, RefundPaymentButton shows confirmation and handles loading/error states, refunded payments show "refunded" status</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete admin payment management: payments list with summary stats, payment detail with related items, Stripe refund processing, admin navigation and dashboard updates</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/admin
    3. Verify: "Payments" appears in admin sidebar navigation
    4. Verify: Admin dashboard shows payments card with count
    5. Click: "Payments" in sidebar → /admin/payments
    6. Verify: Summary stats show total revenue and payment counts
    7. Verify: Payments table shows all payment types with correct badges
    8. Verify: Guest payments show "Guest" indicator with name/email
    9. Verify: Member payments show member name
    10. Click: "View" on any payment → /admin/payments/[id]
    11. Verify: Payment detail shows all info (type, amount, status, Stripe IDs, timestamps)
    12. Verify: Payer info section shows correct member or guest info
    13. Verify: Related items section shows entries/fee purchases/membership info based on type
    14. Verify: Succeeded payments show "Refund" button
    15. Verify: Already refunded payments show "refunded" info (no refund button)
    16. (Optional) Test refund on a test payment if Stripe test mode is configured
    17. Verify: No console errors throughout
    18. Quick check: Existing admin pages (shows, sponsors, results, members, fees) still work
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds without errors
- [ ] /admin/payments list page shows all payments with correct formatting
- [ ] /admin/payments/[id] detail page shows full payment info
- [ ] RefundPaymentButton displays on succeeded payments only
- [ ] processRefund correctly calls Stripe API and updates DB
- [ ] Related items display correctly for each payment type
- [ ] Admin navigation includes Payments item
- [ ] Admin dashboard includes payments card
- [ ] No regressions in existing admin or member portal pages
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Human verification approved
- No TypeScript errors or build warnings
- Admin can view all payments, see details, and process refunds
- Phase 21 complete — v2.0 milestone ready for final review
</success_criteria>

<output>
After completion, create `.planning/phases/21-payment-admin-polish/21-02-SUMMARY.md`

# Phase 21 Plan 02: Payment Detail & Refund Processing Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file` - Description

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 21 complete. v2.0 Member Portal & Payments milestone ready for final review.
</output>
