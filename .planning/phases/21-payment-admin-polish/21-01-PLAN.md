---
phase: 21-payment-admin-polish
plan: 01
type: execute
depends_on: []
files_modified:
  - src/lib/actions/admin-payments.ts
  - src/app/admin/payments/page.tsx
  - src/lib/admin-navigation.ts
  - src/app/admin/page.tsx
---

<objective>
Create admin payment server actions and a payments list page for viewing all payment activity across membership dues, show entry fees, and additional fees — including both member and guest payments.

Purpose: Give admins full visibility into payment activity without needing to log into Stripe Dashboard.
Output: Admin payment server actions, /admin/payments list page with summary stats and filters, updated admin navigation and dashboard.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (payment data layer context):
@.planning/phases/17-membership-payments/17-01-SUMMARY.md
@.planning/phases/20-guest-checkout-additional-fees/20-01-SUMMARY.md

# Key source files:
@src/types/database.ts
@src/lib/actions/payments.ts
@src/lib/actions/admin-members.ts
@src/lib/admin-navigation.ts
@src/app/admin/page.tsx
@src/app/admin/fees/page.tsx
@src/app/admin/members/page.tsx
@src/lib/supabase/admin.ts

**Tech stack available:** Next.js 16 (App Router), Supabase (admin client for service role), Stripe SDK, Tailwind CSS v4
**Established patterns:**
- Admin list pages: server component fetching data, table with status badges, success banners, empty/error states (see fees/page.tsx, members/page.tsx)
- Admin server actions: sanitizeSupabaseError helper, admin role check via RLS, revalidatePath
- Payments use admin client (service role) for all writes; SELECT-only RLS for user-scoped reads
- PaymentRow has 4 payment_type values: membership_dues, membership_renewal, entry_fees, additional_fees
- PaymentRow.member_id is nullable (null = guest payment, has guest_email/guest_name instead)
- Status values: pending, succeeded, failed, refunded

**Constraining decisions:**
- Phase 17: Payments SELECT-only RLS; all writes via service role admin client
- Phase 20: Nullable member_id on payments for guest checkout; guest_email/guest_name fields
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin payment server actions</name>
  <files>src/lib/actions/admin-payments.ts</files>
  <action>
Create src/lib/actions/admin-payments.ts with the following server actions:

1. **getPaymentsAdmin()** — Fetch all payments using admin client (createAdminClient), ordered by created_at DESC. For each payment, resolve the payer identity: if member_id is not null, query the members table to get first_name + last_name; if member_id is null, use guest_name/guest_email. Return an enriched type `AdminPaymentRow` that extends PaymentRow with `payer_name: string` and `payer_email: string | null`. Use a single query to payments, then batch-fetch member names for non-null member_ids (avoid N+1). Return `AdminPaymentRow[] | { error: string }`.

2. **getPaymentsSummary()** — Fetch aggregate stats using admin client: total payment count, total revenue (sum of amount_cents where status='succeeded'), count by payment_type, count by status. Return a typed `PaymentsSummary` object. Use individual count/sum queries rather than loading all rows (efficient for larger datasets).

3. **getPaymentByIdAdmin(id: string)** — Fetch a single payment by ID using admin client. Also fetch related records based on payment_type:
   - For entry_fees: fetch show_entries where payment_id matches, with their show_entry_classes
   - For additional_fees: fetch fee_purchases where payment_id matches
   - For membership types: no additional join needed (info is on the payment itself)
   Return typed `AdminPaymentDetail` with the payment + related records + payer info.

Follow patterns from admin-members.ts: sanitizeSupabaseError helper (copy the pattern), input validation on getPaymentByIdAdmin. Use createAdminClient (NOT createClient) since admin needs to see ALL payments regardless of RLS. Do NOT add admin role checking in the action itself — RLS on the admin client + middleware already handles this.
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>Three server actions exported, AdminPaymentRow/PaymentsSummary/AdminPaymentDetail types exported, no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Create admin payments list page, update navigation and dashboard</name>
  <files>src/app/admin/payments/page.tsx, src/lib/admin-navigation.ts, src/app/admin/page.tsx</files>
  <action>
**A. Create /admin/payments list page (src/app/admin/payments/page.tsx):**

Server component following admin fees/members page patterns. Structure:

1. **Summary stats row** — 3-4 cards at top showing: Total Revenue ($X,XXX.XX from succeeded), Total Payments count, Payments by type breakdown (membership/entries/fees counts). Use getPaymentsSummary(). Style: navy-800 cards with gold-500 accent text for amounts, matching existing admin dashboard card pattern.

2. **Payments table** — Call getPaymentsAdmin(). Table columns: Date (formatted locale date), Payer (name with email subtitle — show "Guest" badge for null member_id), Type (color-coded badge: gold for membership_dues/membership_renewal, blue for entry_fees, purple for additional_fees), Amount ($XX.XX), Status (badge: green=succeeded, yellow=pending, red=failed, blue=refunded), Actions (View link to /admin/payments/[id]).

3. **Status badges** — Reuse the badge pattern from members page (rounded-full, border, bg, text). Create local PaymentTypeBadge and PaymentStatusBadge components within the file.

4. **Standard patterns** — Success banner (for ?success=refunded), error state, empty state. Follow exact patterns from admin fees page.

Format amounts as `$${(amount_cents / 100).toFixed(2)}`. Format dates with `new Date(created_at).toLocaleDateString()`.

**B. Update admin navigation (src/lib/admin-navigation.ts):**

Add "Payments" nav item after "Members" with CreditCardIcon (import from @heroicons/react/24/outline), href "/admin/payments", description "View payments, refunds, and revenue". Insert it between Members and Membership Types in the array.

**C. Update admin dashboard (src/app/admin/page.tsx):**

Add a payments summary card to the contentCards array. Import getPaymentsSummary from admin-payments.ts. Add a card showing payment count (or revenue) with CreditCardIcon, linking to /admin/payments. Also add "View Payments" to quickActions array with CreditCardIcon linking to /admin/payments.
  </action>
  <verify>npm run build succeeds without errors; visiting /admin/payments shows the payments list page</verify>
  <done>Admin payments list page renders with summary stats and table, "Payments" appears in admin sidebar navigation, admin dashboard shows payments card and quick action</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds without errors
- [ ] /admin/payments page renders with summary stats and payment table
- [ ] Payments sorted by most recent first
- [ ] Member payments show member name, guest payments show guest name with "Guest" badge
- [ ] Payment type badges are color-coded by type
- [ ] Status badges match existing patterns (green/yellow/red/blue)
- [ ] "Payments" nav item appears in admin sidebar
- [ ] Admin dashboard includes payments card
- [ ] No regressions in existing admin pages
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors or build warnings introduced
- Admin can view all payments across all types and statuses
- Payment amounts display correctly in dollars (not cents)
</success_criteria>

<output>
After completion, create `.planning/phases/21-payment-admin-polish/21-01-SUMMARY.md`

# Phase 21 Plan 01: Admin Payment Data Layer & Payments List Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file` - Description

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 21-02-PLAN.md (Payment Detail & Refund Processing)
</output>
