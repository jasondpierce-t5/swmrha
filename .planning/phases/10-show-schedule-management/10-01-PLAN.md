---
phase: 10-show-schedule-management
plan: 01
type: execute
depends_on: []
files_modified: [supabase/migrations/001_shows.sql, src/types/database.ts, src/lib/actions/shows.ts]
---

<objective>
Create Supabase shows table with Row Level Security, seed existing static show data, and build server actions for full CRUD operations.

Purpose: Establish the database foundation that all show management UI (admin and public) depends on. Moves show data from static TypeScript file to a queryable, editable database.
Output: Shows table in Supabase with RLS policies, TypeScript database types, and server actions for create/read/update/delete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Prior phase context (auth foundation):
@.planning/phases/09-authentication-admin-foundation/09-01-SUMMARY.md

# Current data model:
@src/data/types.ts
@src/data/shows.ts

# Supabase clients:
@src/lib/supabase/client.ts
@src/lib/supabase/server.ts

**Tech stack available:** @supabase/supabase-js@2.95.3, @supabase/ssr@0.8.0, Next.js 16.1.6, Tailwind CSS v4
**Established patterns:** Three-client Supabase pattern (browser/server/middleware), middleware route protection, RBAC via app_metadata.role
**Constraining decisions:**
- [09-01]: RBAC via app_metadata.role === 'admin' — only service role can modify role, users cannot self-elevate
- [09-01]: Three Supabase client pattern (browser/server/middleware)
- [09-01]: Route protection via middleware — only /admin/* requires auth
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shows table SQL migration and TypeScript types</name>
  <files>supabase/migrations/001_shows.sql, src/types/database.ts</files>
  <action>
Create SQL migration file `supabase/migrations/001_shows.sql` with:

**Table: `shows`**
- `id` uuid primary key default gen_random_uuid()
- `name` text not null (e.g., "The Route 66 Slide")
- `subtitle` text (e.g., "Derby & Rookie Scooter Shootout")
- `dates` text not null (e.g., "April 4-6, 2025" — kept as display text, not date range, matching current data model)
- `location` text not null (e.g., "Carthage, MO")
- `venue` text not null (e.g., "Lucky J Arena and Steakhouse")
- `links` jsonb not null default '[]'::jsonb — array of {label: string, url: string, external: boolean}
- `notes` jsonb not null default '[]'::jsonb — array of strings
- `sort_order` integer not null default 0
- `created_at` timestamptz not null default now()
- `updated_at` timestamptz not null default now()

**RLS policies:**
- Enable RLS on shows table
- `shows_select_policy`: Allow SELECT for everyone (anon + authenticated) — public pages need to read shows
- `shows_insert_policy`: Allow INSERT for authenticated users where `(auth.jwt()->'app_metadata'->>'role') = 'admin'`
- `shows_update_policy`: Allow UPDATE for authenticated users where `(auth.jwt()->'app_metadata'->>'role') = 'admin'`
- `shows_delete_policy`: Allow DELETE for authenticated users where `(auth.jwt()->'app_metadata'->>'role') = 'admin'`

**updated_at trigger:**
- Create a function `update_updated_at()` that sets `updated_at = now()` on row update
- Create trigger on shows table to call this function before update

**Seed data:**
- INSERT the 2 existing shows from src/data/shows.ts (Route 66 Slide and Patriot Slide) with their full links arrays and notes
- Set sort_order 0 and 1 respectively

**TypeScript types** in `src/types/database.ts`:
- `ShowRow` type matching the database columns (id, name, subtitle, dates, location, venue, links as ShowLink[], notes as string[], sort_order, created_at, updated_at)
- `ShowLink` type: { label: string; url: string; external: boolean }
- `ShowInsert` type: Omit<ShowRow, 'id' | 'created_at' | 'updated_at'>
- `ShowUpdate` type: Partial<ShowInsert> & { id: string }

Do NOT use Supabase CLI codegen — define types manually to match the schema. This avoids requiring the Supabase CLI as a dependency.
  </action>
  <verify>
- SQL file exists at supabase/migrations/001_shows.sql and is valid SQL (check syntax)
- TypeScript types compile: `npx tsc --noEmit src/types/database.ts`
- Types match the SQL schema columns exactly
  </verify>
  <done>SQL migration file with table + RLS + trigger + seed data exists; TypeScript types defined and compile without errors</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Run the SQL migration in Supabase to create the shows table</action>
  <instructions>
    I created the SQL migration file at `supabase/migrations/001_shows.sql`.

    Run this SQL in your Supabase project:
    1. Go to your Supabase Dashboard → SQL Editor
    2. Copy the contents of `supabase/migrations/001_shows.sql`
    3. Paste and click "Run"
    4. Verify: Go to Table Editor → you should see a `shows` table with 2 rows (Route 66 Slide and Patriot Slide)
  </instructions>
  <verification>Shows table exists with 2 seeded rows visible in Table Editor</verification>
  <resume-signal>Type "done" when the SQL has been executed successfully</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create server actions for shows CRUD</name>
  <files>src/lib/actions/shows.ts</files>
  <action>
Create `src/lib/actions/shows.ts` with Next.js Server Actions using "use server" directive.

**Import:** createClient from `@/lib/supabase/server`, types from `@/types/database`

**Actions:**
1. `getShows()`: Fetch all shows ordered by sort_order ASC, then created_at DESC. Returns `ShowRow[]`. Uses the server Supabase client. No auth check needed (RLS allows public SELECT).

2. `getShow(id: string)`: Fetch single show by ID. Returns `ShowRow | null`. Validate id is non-empty string before querying.

3. `createShow(data: ShowInsert)`: Insert new show. Validate required fields (name, dates, location, venue) are non-empty strings. Default links to [] if not provided. Returns the inserted `ShowRow`. Call `revalidatePath('/admin/shows')` and `revalidatePath('/shows')` after success.

4. `updateShow(data: ShowUpdate)`: Update existing show by ID. Validate id is non-empty. Only include fields that are actually provided (don't overwrite with undefined). Returns updated `ShowRow`. Call `revalidatePath('/admin/shows')` and `revalidatePath('/shows')` after success.

5. `deleteShow(id: string)`: Delete show by ID. Validate id is non-empty. Returns `{ success: boolean }`. Call `revalidatePath('/admin/shows')` and `revalidatePath('/shows')` after success.

**Error handling:** Each action should catch Supabase errors and return a consistent `{ error: string }` shape on failure. Use `{ data, error }` destructuring from Supabase client responses.

**Security:** Server actions run on the server with the user's session via the server Supabase client. RLS policies enforce admin-only write access. No additional auth checks needed in the actions themselves (middleware + RLS = defense in depth).

Do NOT add `revalidatePath('/')` — only revalidate the specific paths that display shows data.
  </action>
  <verify>
- File compiles without TypeScript errors: `npx tsc --noEmit src/lib/actions/shows.ts`
- All 5 actions exported (getShows, getShow, createShow, updateShow, deleteShow)
- "use server" directive present at top of file
  </verify>
  <done>Server actions file exists with all 5 CRUD operations, proper validation, error handling, and path revalidation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] SQL migration file exists at supabase/migrations/001_shows.sql
- [ ] Shows table created in Supabase with 2 seeded rows
- [ ] RLS policies active (public read, admin write)
- [ ] TypeScript types in src/types/database.ts compile
- [ ] Server actions in src/lib/actions/shows.ts compile
- [ ] All 5 CRUD actions properly exported
</verification>

<success_criteria>

- Shows table exists in Supabase with correct schema and RLS
- 2 existing shows seeded from static data
- TypeScript types match database schema
- Server actions provide full CRUD with validation and error handling
- Path revalidation configured for /admin/shows and /shows
</success_criteria>

<output>
After completion, create `.planning/phases/10-show-schedule-management/10-01-SUMMARY.md`
</output>
