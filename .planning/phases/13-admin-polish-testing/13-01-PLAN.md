---
phase: 13-admin-polish-testing
plan: 01
type: execute
depends_on: []
files_modified: [src/lib/actions/shows.ts, src/lib/actions/sponsors.ts, src/lib/actions/results.ts, src/components/ShowForm.tsx, src/components/SponsorForm.tsx, src/components/ResultForm.tsx]
---

<objective>
Enhance form validation and error handling across all admin CRUD operations.

Purpose: Current admin forms have basic HTML5 required validation and manual server-side checks that expose raw Supabase errors to users. This plan adds proper URL format validation, date logic checks, sanitized error messages, and client-side pre-validation to prevent invalid submissions.
Output: All 3 server action files with robust validation and sanitized errors, all 3 form components with HTML5 validation attributes and improved error display.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (established patterns):
@.planning/phases/10-show-schedule-management/10-02-SUMMARY.md
@.planning/phases/11-sponsor-management/11-02-SUMMARY.md
@.planning/phases/12-results-standings-management/12-02-SUMMARY.md

# Source files to modify:
@src/lib/actions/shows.ts
@src/lib/actions/sponsors.ts
@src/lib/actions/results.ts
@src/components/ShowForm.tsx
@src/components/SponsorForm.tsx
@src/components/ResultForm.tsx

**Established patterns:**
- Server actions return `{ error: string }` on failure, data on success
- Forms use `useTransition` + direct server action calls
- Error display: red border/background alert box at top of form
- Redirect via `redirect()` in server actions after successful operations

**Constraining decisions:**
- Phase 11-02: Plain `<img>` for Storage logos (not next/image)
- Phase 12-01: Category field constrained to 3 values (current_year, past_results, standings)
- Phase 11-02: Level field constrained to 6 options (Platinum through Friends)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance server-side validation and sanitize error messages</name>
  <files>src/lib/actions/shows.ts, src/lib/actions/sponsors.ts, src/lib/actions/results.ts</files>
  <action>
Enhance validation in all 3 server action files:

**shows.ts:**
- Add date logic validation: if both start_date and end_date provided, end_date must be >= start_date. Return error: "End date must be on or after start date"
- Add string length validation: name max 200 chars, location/venue max 200 chars
- Sanitize Supabase errors: wrap all Supabase calls in a helper that maps common error codes to user-friendly messages. For example: duplicate key → "A show with this name already exists", connection error → "Unable to save. Please try again.", generic → "An unexpected error occurred. Please try again."
- Update redirect URLs in createShow and updateShow to include success query param: `redirect('/admin/shows?success=created')` and `redirect('/admin/shows?success=updated')`. Same for deleteShow: `redirect('/admin/shows?success=deleted')`

**sponsors.ts:**
- Add URL format validation for website_url: if provided, must start with http:// or https://. Return error: "Website URL must start with http:// or https://"
- Add string length validation: name max 200 chars
- Sanitize Supabase errors using same helper pattern as shows
- Update redirects to include success query params (created/updated/deleted)

**results.ts:**
- Add URL format validation for url field (required, must start with http:// or https://)
- Add string length validation: label max 200 chars, url max 500 chars
- Sanitize Supabase errors using same helper
- Update redirects to include success query params (created/updated/deleted)

**Create shared helper:** Add a `sanitizeSupabaseError(error: { message: string; code?: string })` function at the top of each action file (or in a shared utility if all 3 files import from same location). Maps:
- "23505" (unique violation) → "This record already exists"
- "PGRST" prefix → "Unable to save. Please try again."
- Connection/timeout → "Unable to connect to database. Please try again."
- Default → "An unexpected error occurred. Please try again."

Do NOT add a separate utility file — keep the helper function in each action file to avoid unnecessary file creation. The function is small (~10 lines) and keeps each file self-contained.
  </action>
  <verify>npm run build passes with no TypeScript errors. Manually verify by reading each file that validation checks are present and redirect URLs include success params.</verify>
  <done>All 3 server action files have URL format validation, date logic (shows), string length limits, sanitized error messages (no raw Supabase errors), and success query params on redirects.</done>
</task>

<task type="auto">
  <name>Task 2: Add HTML5 validation attributes to form components</name>
  <files>src/components/ShowForm.tsx, src/components/SponsorForm.tsx, src/components/ResultForm.tsx</files>
  <action>
Enhance client-side pre-validation using HTML5 attributes on form inputs:

**ShowForm.tsx:**
- Add `maxLength={200}` to name, location, venue inputs
- Add `type="date"` if not already on date inputs
- Ensure all required fields have `required` attribute
- Add `min` attribute to sort_order input (`min={0}`)

**SponsorForm.tsx:**
- Add `maxLength={200}` to name input
- Add `type="url"` and `placeholder="https://example.com"` to website_url input (provides browser-native URL validation)
- Add `min={0}` to sort_order input
- Ensure level select has `required` attribute

**ResultForm.tsx:**
- Add `type="url"` and `placeholder="https://example.com"` to url input
- Add `maxLength={200}` to label input
- Add `maxLength={500}` to url input
- Add `min={0}` to sort_order input
- Ensure category select has `required` attribute

Do NOT add a validation library (Zod, Yup) — HTML5 attributes provide sufficient client-side pre-validation for this admin panel. Keep it simple.

Do NOT change the error display pattern (red alert box at top of form) — it works well and is consistent across all forms.
  </action>
  <verify>npm run build passes. Open each form in browser and verify that submitting empty required fields shows browser-native validation tooltip, URL fields reject non-URL input.</verify>
  <done>All 3 form components have HTML5 validation attributes (maxLength, type="url", min, required) providing client-side pre-validation before server round-trip.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] All 3 server action files have enhanced validation
- [ ] Supabase errors are sanitized (no raw error messages)
- [ ] All redirect URLs include success query params
- [ ] All 3 form components have HTML5 validation attributes
- [ ] No changes to existing functionality (forms still create/edit/delete correctly)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Server-side validation catches invalid URLs, date logic errors, and length overflows
- Client-side HTML5 attributes provide pre-validation feedback
- Error messages are user-friendly (no raw database errors)
- Redirect URLs include success query params for Plan 13-02 to consume
</success_criteria>

<output>
After completion, create `.planning/phases/13-admin-polish-testing/13-01-SUMMARY.md`
</output>
