---
phase: 20-guest-checkout-additional-fees
plan: 04
type: execute
depends_on: ["20-01"]
files_modified: [src/app/member/(portal)/purchase/page.tsx, src/app/member/(portal)/purchase/PurchaseFeeForm.tsx, src/app/member/(portal)/checkout/success/page.tsx, src/app/member/(portal)/checkout/cancel/page.tsx, src/app/member/(portal)/page.tsx, src/lib/member-navigation.ts]
---

<objective>
Integrate additional fee purchases into the member portal with a dedicated purchase page, updated checkout pages, and navigation.

Purpose: Enable authenticated members to purchase stall fees, banquet tickets, and other charges through their portal with pre-filled info and existing Stripe customer.
Output: Member fee purchase page at /member/purchase, updated checkout success/cancel pages for additional_fees, dashboard and navigation integration. Phase 20 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-guest-checkout-additional-fees/20-01-SUMMARY.md

# Key source files
@src/app/member/(portal)/enter-show/ShowEntryForm.tsx
@src/app/member/(portal)/checkout/success/page.tsx
@src/app/member/(portal)/checkout/cancel/page.tsx
@src/app/member/(portal)/page.tsx
@src/lib/member-navigation.ts
@src/lib/actions/fee-checkout.ts

**Established patterns:** Member portal layout with sidebar, context-aware checkout success/cancel pages, dashboard quick links grid, member navigation items
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create member fee purchase page and update checkout pages</name>
  <files>src/app/member/(portal)/purchase/page.tsx, src/app/member/(portal)/purchase/PurchaseFeeForm.tsx, src/app/member/(portal)/checkout/success/page.tsx, src/app/member/(portal)/checkout/cancel/page.tsx</files>
  <action>
  **Member purchase page (page.tsx server component + PurchaseFeeForm.tsx client component):**

  Server component:
  - Fetch active fee items via getActiveFeeItems()
  - Page title: "Purchase Fees" with subtitle "Stall fees, banquet tickets, and event charges"
  - If no active fee items: show "No fee items are currently available for purchase."
  - Pass feeItems to PurchaseFeeForm (member info fetched inside action, not needed as prop)

  Client component (PurchaseFeeForm.tsx):
  - Simpler than public PurchaseForm — no guest info fields needed (auth handled by action)
  - Show member identity: "Purchasing as a signed-in member. Your name and email will be used automatically."
  - Fee items list with quantity selectors (same UI as public version)
  - Running total at bottom
  - "Proceed to Payment — $XX.XX" submit button
  - Calls createFeeCheckoutSession WITHOUT guestEmail/guestName (action detects auth)
  - Redirect to Stripe Checkout on success
  - Error display + loading state

  Follow ShowEntryForm patterns for client component structure. Use member portal styling (navy cards, gold accents, consistent with portal pages).

  **Update checkout success page (success/page.tsx):**
  - Add 'additional_fees' case to the payment_type dispatch logic
  - When payment.payment_type === 'additional_fees': display "Your fee purchase has been confirmed!" heading instead of membership or entry text
  - Action links for additional_fees: "Purchase More" linking to /member/purchase, "View Payment History" to /member/payments
  - Keep existing 'membership_dues', 'membership_renewal', and 'entry_fees' cases unchanged

  **Update checkout cancel page (cancel/page.tsx):**
  - Add 'fees' to the return search param handling
  - If searchParams.return === 'fees': show "Return to Purchase Fees" link pointing to /member/purchase
  - Keep existing 'entries' case and default case unchanged
  </action>
  <verify>npm run build succeeds, /member/purchase renders fee selection, success page shows additional_fees messaging, cancel page handles ?return=fees</verify>
  <done>Member purchase page works with auto-auth, checkout success page handles additional_fees payment type with correct messaging and links, cancel page routes back to /member/purchase</done>
</task>

<task type="auto">
  <name>Task 2: Add navigation and dashboard integration</name>
  <files>src/lib/member-navigation.ts, src/app/member/(portal)/page.tsx</files>
  <action>
  **Member navigation (member-navigation.ts):**
  - Add "Purchase Fees" nav item after "My Entries" (or after "Payment History"):
    - label: "Purchase Fees"
    - href: "/member/purchase"
    - icon: BanknotesIcon (import from @heroicons/react/24/outline)
  - Add the BanknotesIcon import alongside existing heroicon imports

  **Dashboard integration (page.tsx):**
  - Add "Purchase Fees" to the quick links grid:
    - Icon: BanknotesIcon
    - Title: "Purchase Fees"
    - Description: "Stall fees, banquet tickets & more"
    - Link: /member/purchase
  - Position after existing entries-related quick links
  - Do NOT add a full preview section (fee purchases are simpler than entries — a quick link is sufficient)
  </action>
  <verify>npm run build succeeds, member sidebar shows "Purchase Fees" with BanknotesIcon, dashboard quick links grid includes fee purchase option</verify>
  <done>Member navigation includes "Purchase Fees" with correct icon and href, dashboard quick links grid has purchase fees option. Phase 20 complete.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] /member/purchase shows fee items with member-aware checkout
- [ ] Checkout success page correctly handles 'additional_fees' payment type
- [ ] Checkout cancel page handles ?return=fees with correct link
- [ ] Member navigation includes "Purchase Fees" with BanknotesIcon
- [ ] Dashboard quick links includes purchase fees option
- [ ] No regressions in existing membership or entry payment flows
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Members can purchase fees from portal with auto-auth
- Checkout success/cancel pages dispatch correctly for all payment types
- Navigation and dashboard updated
- Phase 20 complete — ready for Phase 21
  </success_criteria>

<output>
After completion, create `.planning/phases/20-guest-checkout-additional-fees/20-04-SUMMARY.md`

Phase 20 complete, ready for Phase 21 (Payment Admin & Polish).
</output>
