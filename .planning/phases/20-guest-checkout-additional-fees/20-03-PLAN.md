---
phase: 20-guest-checkout-additional-fees
plan: 03
type: execute
depends_on: ["20-01"]
files_modified: [src/app/purchase/page.tsx, src/app/purchase/PurchaseForm.tsx, src/app/purchase/success/page.tsx, src/app/purchase/cancel/page.tsx]
---

<objective>
Build the public-facing fee purchase page and guest checkout flow with success/cancel pages.

Purpose: Enable non-members (guests) to purchase stall fees, banquet tickets, and other event charges without creating an account.
Output: Public /purchase page with fee selection + guest info form, /purchase/success and /purchase/cancel checkout pages.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-guest-checkout-additional-fees/20-01-SUMMARY.md

# Key source files — follow these patterns
@src/app/member/(portal)/enter-show/ShowEntryForm.tsx
@src/app/member/(portal)/checkout/success/page.tsx
@src/app/member/(portal)/checkout/cancel/page.tsx
@src/lib/actions/fee-checkout.ts

**Established patterns:** Multi-step/section forms, Stripe checkout redirect, context-aware success/cancel pages, dark western-professional theme (navy bg, gold accents, white text)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create public fee purchase page with guest info and fee selection</name>
  <files>src/app/purchase/page.tsx, src/app/purchase/PurchaseForm.tsx</files>
  <action>
  **Server component (page.tsx):**
  - Fetch active fee items via getActiveFeeItems() from fee-items.ts (no auth required)
  - Optionally try to detect authenticated user: import createClient, call auth.getUser() — if user exists, fetch member profile for pre-fill. Do NOT error on unauthenticated.
  - Pass feeItems and optional memberInfo (name, email) to PurchaseForm
  - Page title: "Purchase Event Fees" with subtitle "Stall fees, banquet tickets, and more"
  - If no active fee items: show "No fee items are currently available for purchase."

  **Client component (PurchaseForm.tsx):**
  Two-section layout:

  **Section 1: Your Information**
  - If memberInfo provided (authenticated): show read-only display "Purchasing as [First Last] ([email])" with a small info note. No editable fields needed — checkout action uses auth.
  - If no memberInfo (guest): show required fields:
    - First Name (text, required)
    - Last Name (text, required)
    - Email (email input, required)
  - Validate email format on submit (basic regex check)

  **Section 2: Select Items**
  - List fee items in cards/rows grouped by category (if multiple categories exist)
  - Each item shows: name, description (if any), price formatted as dollars
  - Quantity selector: number input or +/- buttons, min 1, max = max_quantity_per_order or 10
  - Default quantity: 0 (not selected). User increments to add items.
  - Running total at bottom: sum of (price * quantity) for all selected items, formatted as dollars
  - "No items selected" state when all quantities are 0

  **Submit button:**
  - "Proceed to Payment — $XX.XX" (show total in button)
  - Disabled when no items selected (total = 0)
  - On click: collect selected items (quantity > 0), build input for createFeeCheckoutSession
  - If guest: pass guestEmail and guestName from form fields
  - If authenticated: omit guestEmail/guestName (action detects auth)
  - On success (url returned): redirect via window.location.href
  - On error: display error message below button
  - Loading state: "Redirecting to Payment..." with disabled button

  **Styling:**
  - Dark western-professional theme consistent with rest of site
  - Navy card backgrounds, gold accents for prices and buttons
  - Responsive: stack sections vertically on mobile, side-by-side on desktop if space allows
  - Use existing site layout (header/footer from root layout should apply)
  </action>
  <verify>npm run build succeeds, /purchase page renders fee items, form shows guest info fields when not logged in</verify>
  <done>Public purchase page lists active fee items with quantity selection, collects guest name/email, shows running total, initiates Stripe Checkout on submit</done>
</task>

<task type="auto">
  <name>Task 2: Create public checkout success and cancel pages</name>
  <files>src/app/purchase/success/page.tsx, src/app/purchase/cancel/page.tsx</files>
  <action>
  **Success page (/purchase/success/page.tsx):**
  - Server component reading session_id from URL search params (searchParams prop)
  - If session_id present:
    - Use Stripe server SDK (getStripeServer) to retrieve checkout session: stripe.checkout.sessions.retrieve(session_id)
    - Display green checkmark icon (use CheckCircleIcon from heroicons)
    - "Payment Confirmed!" heading
    - Amount: session.amount_total / 100 formatted as $XX.XX
    - Email: session.customer_details?.email — "A receipt has been sent to [email]"
    - Payment status badge (should be "complete" or "paid")
  - If no session_id or Stripe retrieval fails:
    - Generic "Thank You!" message
    - "Your payment has been processed."
  - Action links:
    - "Purchase More" link to /purchase
    - "Return to Home" link to /
  - Do NOT require authentication — this page serves guest users
  - Style: green tones for success, consistent with member success page (gold accents, navy background)

  **Cancel page (/purchase/cancel/page.tsx):**
  - Simple server component (no data fetching)
  - Red X icon (XCircleIcon from heroicons)
  - "Payment Cancelled" heading
  - "No charges were made. You can try again whenever you're ready."
  - Action links:
    - "Try Again" link to /purchase
    - "Return to Home" link to /
  - Style: red tones for cancel, consistent with member cancel page

  Both pages should use the site's root layout (header/footer). They do NOT use the member portal layout.
  </action>
  <verify>npm run build succeeds, /purchase/success renders with session data, /purchase/cancel renders cancellation message with retry link</verify>
  <done>Guest success page retrieves Stripe session and shows payment confirmation, cancel page offers retry and home links</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Public fee purchase page with guest checkout flow — fee selection, guest info form, Stripe Checkout redirect, success/cancel pages</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/purchase (while NOT logged in)
    3. Verify: Fee items display with names, descriptions, prices
    4. Verify: Guest info fields (First Name, Last Name, Email) are shown and required
    5. Select: At least one fee item, set quantity to 1+
    6. Verify: Running total updates correctly
    7. Enter: Guest name and email
    8. Click: "Proceed to Payment" button
    9. Verify: Redirected to Stripe Checkout with correct line items
    10. (In Stripe test mode) Complete payment with card 4242 4242 4242 4242
    11. Verify: Redirected to /purchase/success with payment amount and email displayed
    12. Navigate to /purchase/cancel directly — verify cancellation message with "Try Again" link
    13. (Optional) Visit /purchase while logged in as member — verify info is pre-filled and fields are read-only
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] /purchase page loads without auth requirement
- [ ] Fee items display with correct prices (dollars)
- [ ] Guest info form validates required fields
- [ ] Quantity selectors work with running total
- [ ] Checkout creates Stripe session and redirects correctly
- [ ] /purchase/success shows payment confirmation from Stripe session
- [ ] /purchase/cancel shows cancellation message with retry link
- [ ] Authenticated members see pre-filled info on /purchase
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Guest can purchase fees without creating an account
- Success page shows payment details from Stripe
- Cancel page provides retry option
- Page styling consistent with existing site theme
  </success_criteria>

<output>
After completion, create `.planning/phases/20-guest-checkout-additional-fees/20-03-SUMMARY.md`
</output>
