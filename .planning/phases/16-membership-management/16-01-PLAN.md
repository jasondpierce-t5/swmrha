---
phase: 16-membership-management
plan: 01
type: execute
depends_on: []
files_modified: [supabase/migrations/005_membership_types.sql, src/types/database.ts, src/lib/actions/membership-types.ts, src/lib/actions/admin-members.ts, src/lib/admin-navigation.ts]
---

<objective>
Create the membership_types database table, TypeScript types, all server actions for membership type CRUD and admin member management, and update admin navigation.

Purpose: Establish the data layer and actions that both admin UI plans (16-02, 16-03) depend on. The membership_types table provides configurable tiers with pricing that Phase 17 will use for Stripe checkout.
Output: SQL migration ready for execution, compiled TypeScript types, server actions following established patterns, admin nav with Members and Membership Types items.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (dependency graph):
@.planning/phases/14-stripe-foundation-member-auth/14-02-SUMMARY.md
@.planning/phases/15-member-portal-profiles/15-01-SUMMARY.md
@.planning/phases/15-member-portal-profiles/15-02-SUMMARY.md

# Key source files (established patterns to follow):
@src/types/database.ts
@src/lib/actions/shows.ts
@src/lib/actions/sponsors.ts
@src/lib/actions/members.ts
@src/lib/admin-navigation.ts
@supabase/migrations/004_members_table.sql

**Tech stack available:** Next.js 16, Supabase, Tailwind CSS v4, Stripe SDK, @heroicons/react
**Established patterns:** sanitizeSupabaseError, server actions with revalidatePath, admin CRUD pattern (list/create/edit/delete), MemberRow type
**Constraining decisions:**
- Phase 14: Members table uses auth.users id as PK, membership_type is text field (individual/family/youth/lifetime)
- Phase 15: updateMemberProfile restricts to name/phone/address fields — system fields (type, status, dates) are admin-managed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create membership_types table migration and TypeScript types</name>
  <files>supabase/migrations/005_membership_types.sql, src/types/database.ts</files>
  <action>
  Create SQL migration for membership_types table:
  - id (uuid PK, gen_random_uuid())
  - name (text NOT NULL UNIQUE) — display name like "Individual", "Family"
  - slug (text NOT NULL UNIQUE) — lowercase key matching members.membership_type values
  - description (text) — tier description for public display
  - price_cents (integer NOT NULL DEFAULT 0) — price in cents for Stripe (e.g., 5000 = $50.00)
  - duration_months (integer) — NULL for lifetime memberships
  - benefits (jsonb DEFAULT '[]'::jsonb) — array of benefit strings
  - sort_order (integer NOT NULL DEFAULT 0)
  - is_active (boolean NOT NULL DEFAULT true) — soft-disable without deleting
  - created_at (timestamptz NOT NULL DEFAULT now())
  - updated_at (timestamptz NOT NULL DEFAULT now())

  Add updated_at trigger (reuse pattern from 004 if exists, or create: set_updated_at function + trigger).

  RLS policies:
  - "Anyone can read active membership types" — SELECT where is_active = true, no auth required (public pricing page needs this)
  - "Admins can manage membership types" — ALL for users with app_metadata.role = 'admin'

  Seed with 4 default types matching current hardcoded values:
  INSERT INTO membership_types (name, slug, description, price_cents, duration_months, sort_order) VALUES
    ('Individual', 'individual', 'Standard individual membership for one person', 5000, 12, 1),
    ('Family', 'family', 'Family membership covering an entire household', 7500, 12, 2),
    ('Youth', 'youth', 'Youth membership for members under 18', 2500, 12, 3),
    ('Lifetime', 'lifetime', 'One-time lifetime membership', 50000, NULL, 4);

  Do NOT add FK constraint from members.membership_type to membership_types — keep the text field loosely coupled for now. The slug values match by convention.

  In src/types/database.ts, add:
  - MembershipTypeRow interface matching all columns (id, name, slug, description, price_cents, duration_months, benefits as string[], sort_order, is_active, created_at, updated_at)
  - MembershipTypeInsert type: Omit MembershipTypeRow of 'id' | 'created_at' | 'updated_at' with optional fields for defaults (sort_order, is_active, benefits, price_cents)
  </action>
  <verify>npx tsc --noEmit passes with new types</verify>
  <done>Migration SQL file exists with table, RLS, trigger, seed data. MembershipTypeRow and MembershipTypeInsert types compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create server actions and update admin navigation</name>
  <files>src/lib/actions/membership-types.ts, src/lib/actions/admin-members.ts, src/lib/admin-navigation.ts</files>
  <action>
  **membership-types.ts** — Follow src/lib/actions/shows.ts pattern exactly:
  - Import createClient from @/lib/supabase/server, import MembershipTypeRow/MembershipTypeInsert from @/types/database
  - sanitizeSupabaseError function (reuse pattern from shows.ts)
  - getMembershipTypes(): Select all ordered by sort_order ASC. Return MembershipTypeRow[] or { error: string }
  - getActiveMembershipTypes(): Select where is_active = true, ordered by sort_order. For public pages.
  - getMembershipType(id: string): Select by id with .maybeSingle(). Validate id not empty.
  - createMembershipType(data: MembershipTypeInsert): Validate required fields (name min 1 char max 100, slug min 1 char max 50 lowercase alphanumeric+hyphens, price_cents >= 0, duration_months > 0 or null). Insert and return row. Revalidate /admin/membership-types and /membership.
  - updateMembershipType(id: string, data: Partial<MembershipTypeInsert>): Validate id, validate provided fields same as create. Update and return row. Revalidate same paths.
  - deleteMembershipType(id: string): Validate id. Delete and return { success: true } or { error }. Revalidate same paths.

  **admin-members.ts** — Admin-specific member management actions:
  - Import createClient, MemberRow from types
  - sanitizeSupabaseError function
  - getMembers(): Select all from members, ordered by last_name ASC, first_name ASC. Return MemberRow[] or { error }.
  - getMemberById(id: string): Select by id with .maybeSingle(). Validate id.
  - updateMemberAdmin(id: string, data: AdminMemberUpdate): Can update ALL fields including system fields (membership_type, membership_status, membership_start, membership_expiry, stripe_customer_id) plus personal fields. Validate: first_name/last_name required (1-100 chars), membership_type must be non-empty string, membership_status must be one of pending/active/expired/suspended. Update .eq('id', id). Revalidate /admin/members, /member, /member/profile.
  - deleteMember(id: string): Delete from members table. Return { success } or { error }. Revalidate /admin/members.
  - Define AdminMemberUpdate interface: all MemberRow fields except id, email, created_at, updated_at (email is from auth, not editable here).

  **admin-navigation.ts** — Add two new items following existing pattern:
  - "Members" with UserGroupIcon from @heroicons/react/24/outline, href "/admin/members", description "View and manage members"
  - "Membership Types" with TagIcon from @heroicons/react/24/outline, href "/admin/membership-types", description "Configure membership tiers and pricing"
  - Place after existing items (after Results)
  </action>
  <verify>npm run build passes without errors</verify>
  <done>All 6 membership type actions + 4 admin member actions compile. Admin navigation shows Members and Membership Types items. Build succeeds.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] Migration SQL file has valid syntax (table, RLS, trigger, seed)
- [ ] All server action functions are exported and importable
- [ ] Admin navigation includes both new items
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Migration ready for execution in Supabase Dashboard
- Server actions follow established patterns (validation, error handling, revalidation)
- Admin navigation updated with Members and Membership Types
  </success_criteria>

<output>
After completion, create `.planning/phases/16-membership-management/16-01-SUMMARY.md`
</output>
